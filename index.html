<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ILS ‚Äî Readings</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
  <meta name="theme-color" content="#000000">

  <style>

/* =========================================================
   GBAV ‚Äî V1.0 FIELD (Themes isolated, no mixing)
   Day  : "V8" (bleu/acier)  -> body.theme-day
   Night: "ARES" (rouge sombre) -> body.theme-night
   IMPORTANT:
   - Layout/component styles use CSS variables ONLY.
   - Themes only change variables (no selector spaghetti).
   ========================================================= */

/* ---------- THEME TOKENS (variables) ---------- */
:root{
  --glow1: rgba(47,129,247,.10);
  --glow2: rgba(245,158,11,.07);
  --bg:#0f1115;
  --panel:#151925;
  --panel2:#101421;
  --text:#e7eaf2;
  --muted:#aab2c5;
  --line:#263049;

  --ok:#22c55e;
  --bad:#ef4444;
  --warn:#f59e0b;

  --ylw:#facc15;

  --headIcon:56px;
  --vvTop: env(safe-area-inset-top, 0px);

  
  --headerH:0px;
--btn:#2d6cdf;
  --btn2:#1f4ea5;

  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --r:14px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  --sans: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

/* Day (V8 look) */
body.theme-day{
  /* NAV CANADA day ‚Äî deep blue, high contrast */
  --bg:#E6EBF0;      /* light bluish gray bg */
  --panel:#072A45;   /* card surface */
  --panel2:#06243C;  /* secondary surface */
  --text:#F2F7FF;
  --muted:#B8C9DF;
  --line:#123A5A;

  --ok:#22c55e;
  --bad:#ef4444;
  --warn:#f59e0b;

  --ylw:#facc15;

  --btn:#0A84FF;     /* iOS-ish blue */
  --btn2:#0066CC;

  --glow1: rgba(0,118,200,.14); /* NAV blue glow */
  --glow2: rgba(0,118,200,.06); /* subtle second glow */

  --shadow: 0 14px 40px rgba(0,0,0,.45);
  --r:16px;
}

/* Night (Nocturne m√©tal) */
body.theme-night{
  /* Gunmetal + steel blue */
  --bg:#05070a;
  --panel:#0b1016;
  --panel2:#080c11;
  --text:#e6edf7;
  --muted:#a1aec2;
  --line:#162232;

  --ok:#3bb273;
  --bad:#b01626;
  --warn:#c58b18;

  --ylw:#d9c26a;

  /* Accent ‚Äúbleu m√©tallique‚Äù */
  --btn:#2d6cdf;
  --btn2:#14375f;

  --glow1: rgba(45,108,223,.10);
  --glow2: rgba(190,205,230,.04);

  --shadow: 0 18px 50px rgba(0,0,0,.60);
  --r:16px;
}

/* ---------- BASE ---------- */
*{ box-sizing:border-box; }
html,body{ min-height:100%; }
html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
body{
  margin:0;
  font-family:var(--sans);
  background:
    radial-gradient(1200px 650px at 20% 0%, var(--glow1), transparent 55%),
    radial-gradient(900px 500px at 80% 10%, var(--glow2), transparent 50%),
    var(--bg);
  color:var(--text);
}

/* Night background: noir + reflets acier */
body.theme-night{
  background:
    radial-gradient(1100px 650px at 20% 0%, rgba(45,108,223,.10), transparent 55%),
    radial-gradient(900px 520px at 80% 10%, rgba(190,205,230,.04), transparent 50%),
    linear-gradient(180deg, rgba(255,255,255,.03), transparent 38%),
    var(--bg);
}
/* ---------- HEADER (rigide, lisible, mobile-safe) ---------- */
header{
  position: fixed;
  top:0;
  left:0;
  right:0;
  z-index:50;

  display:grid;
  grid-template-columns: var(--headIcon) minmax(0,1fr) var(--headIcon);
  gap:14px;
  align-items:center;

  padding: calc(12px + var(--vvTop)) 14px 12px;
  background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.20));
  border-bottom:1px solid rgba(255,255,255,.08);
  backdrop-filter: blur(8px);
}

/* Header left container (fixed width for perfect centering) */
.headerLeft{ width: var(--headIcon); display:flex; align-items:center; justify-content:flex-start; }


/* Branding texte */
.brandInstitutional{
  font-weight: 700;
  letter-spacing: .28em;
  font-size: 15px;
  color: rgba(231,234,242,.92);
  user-select:none;
}

/* Logo / Easter egg trigger (5 taps) */
.brandQuad{
  width:var(--headIcon);
  height:var(--headIcon);
  border-radius:18px;
  display:grid;
  place-items:center;
  cursor:pointer;
  user-select:none;

  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  box-shadow: 0 10px 24px rgba(0,0,0,.25);
  color: rgba(231,234,242,.95);
}
body.theme-day .brandQuad{
  background: rgba(255,255,255,.08);
  border-color: rgba(255,255,255,.14);
  box-shadow: 0 14px 28px rgba(0,0,0,.28);
}
.brandQuad:active{ transform: translateY(1px); }

.brandQuad .gbavLogo{
  width:calc(var(--headIcon) - 4px);
  height:calc(var(--headIcon) - 4px);
  display:block;
}

/* Title / subtitle */
.headerCenter{
  min-width:0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
}
.headerCenter .titleLine{
  min-width:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
}
.headerCenter h1{
  margin:0;
  font-weight: 850;
  letter-spacing: .02em;
  line-height: 1.05;
  font-size: clamp(18px, 2.7vw, 26px);
}
.headerCenter .sub{
  margin:0;
  color: rgba(231,234,242,.70);
  font-size: clamp(12px, 1.8vw, 14px);
  line-height: 1.15;
}
.sub .docRef{ display:block; }

@media (max-width: 520px){
  .headerCenter .titleLine{ gap:6px; }
}
/* Theme toggle: icon only */
.themeToggle{
  width: var(--headIcon);
  height: var(--headIcon);
  border-radius: 18px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color: var(--text);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 22px;
  padding:0;
}
.themeToggle:hover{ background: rgba(255,255,255,.08); }
.themeToggle:active{ transform: translateY(1px); }


/* ---------- MAIN PANEL ---------- */
.wrap{ padding: calc(16px + var(--headerH)) 14px 110px; }
.panel{
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)), var(--panel);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 18px;
  box-shadow: var(--shadow);
  padding: 16px;
  max-width: 900px;
  margin: 0 auto;
}

/* Intro grid (step 0/10) */
.grid2{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap: 12px;
}

.txRow{
  margin-top: 10px;
  display:flex;
  flex-direction: column;
  gap: 8px;
  align-items: center;
}
.txRow > label{
  font-size: 13px;
  color: rgba(231,234,242,.70);
}
.txChoice{
  display:flex;
  gap: 12px;
  justify-content: center;
}
.txOpt{
  display:flex;
  align-items:center;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  cursor: pointer;
  user-select: none;
}
.txOpt input{ width:auto; padding:0; border:0; box-shadow:none; }
@media (max-width: 520px){
  .grid2{ grid-template-columns: 1fr; }
}

/* Titles inside steps */
.stepHdr{
  display:flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 8px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  color: rgba(231,234,242,.92);
  font-weight: 800;
}

/* Section title */
.secTitle{
  margin: 18px 0 10px;
  font-weight: 900;
  letter-spacing: .08em;
  color: rgba(231,234,242,.92);
  text-align:center;
}

/* Description de valeur (m√™me style que .secTitle, mais en jaune) */
.consignDesc{
  margin: 0 0 10px;
  font-weight: 900;
  letter-spacing: .02em;
  color: #facc15;
  text-align:center;
}

/* TX highlight inside yellow consignDesc */
.txRed{ color: var(--bad); font-weight: 900; }

/* Boxes (content blocks) */
.box{
  background: color-mix(in srgb, var(--panel2) 82%, transparent);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 16px;
  padding: 12px;
}

/* Fields */
.fieldLine{ margin-top: 12px; display:flex; align-items:center; justify-content:center; gap:12px; }
.fieldLine input{ width:100%; max-width:460px; }
.fieldLine .unit{
  }

/* Site/ID picker */
.siteRow{
  display:flex;
  gap:10px;
  align-items:stretch;
  justify-content:center;
}
.siteRow input{
  flex: 2 1 0;
  max-width:none !important;
  height: 44px;
}
.chooseBtn{
  flex: 1 1 0;
  min-width:0;
  height: 44px;
  padding: 0 10px;
}
.sitePickList{
  display:grid;
  gap:10px;
  margin-top: 10px;
}
.sitePickItem{
  border-radius: 12px;
  padding: 10px 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(231,234,242,.95);
  font-weight: 900;
  text-align:left;
}
.sitePickItem:active{ transform: translateY(1px); }
.sitePickItem.isActive{
  border-color: rgba(255, 80, 80, .55);
  background: rgba(255, 60, 60, .12);
}
.sitePickItem .muted{
  display:block;
  margin-top:4px;
  font-weight: 700;
  color: rgba(231,234,242,.70);
  font-size: 12px;
}
 min-width:3ch; text-align:left; }
.inlineLabel{ margin-top:10px; text-align:center; font-weight:800; letter-spacing:.01em; }
.fieldLine label{
  display:block;
  font-size: 13px;
  color: rgba(231,234,242,.70);
  margin: 0 0 6px;
}
input, textarea, select{
  width:100%;
  background: color-mix(in srgb, var(--panel2) 86%, transparent);
  color: var(--text);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  padding: 14px 14px;
  font-size: 16px;
  outline:none;
}
textarea{ min-height: 110px; resize: vertical; }

/* Day theme: writing fields = white background, black bold text (night unchanged) */
body.theme-day input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="file"]),
body.theme-day textarea,
body.theme-day select{
  background: #ffffff;
  color: #000000;
  font-weight: 800;
  border-color: rgba(0,0,0,.18);
}
body.theme-day input::placeholder,
body.theme-day textarea::placeholder{
  color: rgba(0,0,0,.45);
  font-weight: 700;
}

/* --------- STEP LAYOUT (centered forms) ---------
   Only applies to measurement steps (1/10 ‚Üí 10/10).
*/
body.mode-step .secTitle{ text-align:center; }
body.mode-step .stepHdr{ justify-content:center; text-align:center; }
body.mode-step .big{ text-align:center; }
body.mode-step .pill{ display:block !important; text-align:center; width:fit-content; margin: 0 auto 10px !important; }

body.mode-step .box{ max-width: 900px; margin: 0 auto; }

body.mode-step .grid2{ max-width: 900px; margin: 0 auto; }

/* Step 0/10 (Intro) ‚Äî center the meta fields */
body.mode-step .grid2 > div{
  display:flex;
  flex-direction:column;
  align-items:center;
}
body.mode-step .grid2 > div > label{ text-align:center; width:100%; }
body.mode-step .grid2 > div > input,
body.mode-step .grid2 > div > select{
  max-width: 520px;
}

body.mode-step .fieldLine{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
}

body.mode-step .fieldLine label{ text-align:center; }

body.mode-step .fieldLine input,
body.mode-step .fieldLine textarea,
body.mode-step .fieldLine select{
  max-width: 720px;
}

body.mode-step .fieldLine .unit{
  }

/* Site/ID picker */
.siteRow{
  display:flex;
  gap:10px;
  align-items:stretch;
  justify-content:center;
}
.siteRow input{
  flex: 2 1 0;
  max-width:none !important;
  height: 44px;
}
.chooseBtn{
  flex: 1 1 0;
  min-width:0;
  height: 44px;
  padding: 0 10px;
}
.sitePickList{
  display:grid;
  gap:10px;
  margin-top: 10px;
}
.sitePickItem{
  border-radius: 12px;
  padding: 10px 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(231,234,242,.95);
  font-weight: 900;
  text-align:left;
}
.sitePickItem:active{ transform: translateY(1px); }
.sitePickItem.isActive{
  border-color: rgba(255, 80, 80, .55);
  background: rgba(255, 60, 60, .12);
}
.sitePickItem .muted{
  display:block;
  margin-top:4px;
  font-weight: 700;
  color: rgba(231,234,242,.70);
  font-size: 12px;
}
 text-align:center; }

input::placeholder, textarea::placeholder{ color: rgba(231,234,242,.35); }

input:focus, textarea:focus, select:focus{
  border-color: rgba(255,255,255,.22);
  box-shadow: 0 0 0 2px rgba(45,108,223,.25);
}
body.theme-night input:focus,
body.theme-night textarea:focus,
body.theme-night select:focus{
  box-shadow: 0 0 0 2px rgba(193,18,31,.25);
}

/* Day (V8) focus ring */
body.theme-day input:focus,
body.theme-day textarea:focus,
body.theme-day select:focus{
  border-color: rgba(47,129,247,.85);
  box-shadow: 0 0 0 3px rgba(47,129,247,.22);
}
/* Units & helper text */
.unit, .tiny{
  color: rgba(231,234,242,.65);
  font-size: 14px;
}
.mono{ font-family: var(--mono); }

/* ---------- BUTTONS / NAV ---------- */
.btnRow{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  display:flex;
  justify-content:center;   /* centr√© horizontalement */
  align-items:center;       /* centr√© verticalement */
  gap: 12px;
  padding: 18px 14px calc(18px + env(safe-area-inset-bottom, 0px));
  background: rgba(0,0,0,.15);
  backdrop-filter: blur(8px);

}
button{
  flex:1;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  padding: 14px 14px;
  font-size: 16px;
  font-weight: 900;
  letter-spacing: .02em;
  color: var(--text);
  background: linear-gradient(180deg, var(--btn), var(--btn2));
  box-shadow: 0 10px 24px rgba(0,0,0,.35);
}
button.secondary{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.14);
  box-shadow: none;
}
button.danger{
  background: linear-gradient(180deg, #b91c1c, #7f1d1d);
}
button:active{ transform: translateY(1px); }

/* ---------- NAV BUTTONS (mechanical feel) ----------
   Only styles the bottom Next/Prev buttons (does not affect other buttons).
*/
.btnRow .navBtn{
  position: relative;
  overflow: hidden;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.16);
  padding: 15px 14px;
  text-transform: uppercase;
  letter-spacing: .08em;
  font-weight: 950;
  box-shadow:
    0 14px 28px rgba(0,0,0,.38),
    inset 0 1px 0 rgba(255,255,255,.18),
    inset 0 -3px 0 rgba(0,0,0,.35);
  transform: translateZ(0);
  transition: transform .06s ease, box-shadow .12s ease, filter .12s ease;
}


/* Home reset button: compact pill */
.resetBtnHome{
  width: fit-content;
  flex: 0 0 auto;
  max-width: 100%;
  padding: 10px 18px;
  font-size: 15px;
  border-radius: 14px;
  white-space: nowrap;
  background: linear-gradient(180deg, rgba(255,255,255,.80), rgba(180,190,205,.85));
  color: #0b0f18;
  border: 1px solid rgba(0,0,0,.30);
  box-shadow:
    0 12px 22px rgba(0,0,0,.28),
    inset 0 1px 0 rgba(255,255,255,.70),
    inset 0 -3px 0 rgba(0,0,0,.25);
}
.btnRow .homeBtn{
  flex: 0 0 54px;
  width: 54px;
  height: 54px;
  padding: 0;
  border-radius: 18px;
  text-transform: none;
  letter-spacing: 0;
  display: grid;
  place-items: center;
}
.btnRow .homeBtn svg{
  width: 22px;
  height: 22px;
  fill: #ffffff;
}

/* ‚Äúknurled‚Äù mechanical texture */
.btnRow .navBtn::before{
  content:"";
  position:absolute; inset:0;
  background:
    repeating-linear-gradient(135deg,
      rgba(255,255,255,.08) 0px,
      rgba(255,255,255,.08) 2px,
      rgba(0,0,0,.10) 2px,
      rgba(0,0,0,.10) 4px);
  opacity:.22;
  mix-blend-mode: overlay;
  pointer-events:none;
}

/* top highlight / metal sheen */
.btnRow .navBtn::after{
  content:"";
  position:absolute;
  left:-20%;
  top:-60%;
  width:140%;
  height:120%;
  background: radial-gradient(closest-side, rgba(255,255,255,.22), transparent 60%);
  opacity:.55;
  transform: rotate(-12deg);
  pointer-events:none;
}

.btnRow .navBtn:active{
  transform: translateY(2px);
  box-shadow:
    0 8px 16px rgba(0,0,0,.34),
    inset 0 1px 0 rgba(255,255,255,.14),
    inset 0 -2px 0 rgba(0,0,0,.42);
  filter: saturate(1.05) contrast(1.02);
}

/* Secondary (Prev) looks like a ‚Äúmetal plate‚Äù */
.btnRow .navBtn.secondary{
  background:
    linear-gradient(180deg,
      color-mix(in srgb, var(--btn) 62%, rgba(255,255,255,.10)),
      color-mix(in srgb, var(--btn2) 70%, rgba(0,0,0,.25)));
  border-color: rgba(255,255,255,.14);
}


/* Reset: fond argent, texte blanc, contour noir (toutes th√©matiques) */
#btnResetHome{
  background: linear-gradient(180deg, #c9cfd8, #8e96a5) !important;
  color:#ffffff !important;
  border-color:#000000 !important;
  text-shadow: 0 1px 0 rgba(0,0,0,.35);
  box-shadow:
    0 10px 22px rgba(0,0,0,.28),
    inset 0 1px 0 rgba(255,255,255,.55),
    inset 0 -3px 0 rgba(0,0,0,.22) !important;
}
#btnResetHome:hover{
  filter: brightness(1.05);
}
#btnResetHome:active{
  transform: translateY(1px);
  filter: brightness(.98);
}
#btnResetHome:focus-visible{
  outline: 2px solid rgba(0,0,0,.65);
  outline-offset: 2px;
}

/* Primary (Next) gets stronger ‚Äúaction‚Äù emphasis */
.btnRow .navBtn.navNext{
  border-color: rgba(255,255,255,.20);
  box-shadow:
    0 16px 34px rgba(0,0,0,.42),
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -4px 0 rgba(0,0,0,.38),
    0 0 0 2px color-mix(in srgb, var(--btn) 28%, transparent);
}

/* Accessibility: visible focus */
.btnRow .navBtn:focus-visible{
  outline:none;
  box-shadow:
    0 16px 34px rgba(0,0,0,.42),
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -4px 0 rgba(0,0,0,.38),
    0 0 0 3px color-mix(in srgb, var(--btn) 38%, transparent);
}

/* --- MODE TOGGLE (Lecture (FFM/PIR) / GBAV) --- */
.gbavToggle{
  /* Match CAT buttons look */
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--text);
  padding: 10px 18px;
  font-weight: 900;
  letter-spacing: .02em;
  cursor: pointer;
  user-select: none;
  min-width: 140px;
  width: auto;
  margin: 0 auto;
  text-transform: uppercase;
  box-shadow: 0 10px 22px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.10);
}
.gbavToggle.isOn{
  /* Selected = red */
  background: linear-gradient(180deg, rgba(239,68,68,.95), rgba(185,28,28,.95));
  border-color: rgba(239,68,68,.55);
  box-shadow:
    0 14px 28px rgba(0,0,0,.35),
    0 0 0 2px rgba(239,68,68,.16),
    inset 0 1px 0 rgba(255,255,255,.16),
    inset 0 -3px 0 rgba(0,0,0,.35);
}

.catGroup{
  display:flex;
  justify-content:center;
  gap:10px;
}
.equipGroup{
  display:flex;
  justify-content:center;
  gap:10px;
}

.homeStack{
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  align-items: center;
}

/* Meta fields under home buttons */
.metaStack{
  margin-top: 0;
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: center;
}

/* Spacer where extra info can be added later */
.homeStack .equipRow,
.homeStack .catRow,
.homeStack .txRow{
  width: 100%;
}

.catBtn{
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--text);
  padding: 8px 12px;
  font-weight: 900;
  letter-spacing: .02em;
  cursor: pointer;
  user-select: none;
  min-width: 84px;
}
.catBtn.isOn{
  background: linear-gradient(180deg, var(--ylw), #ca8a04);
  border-color: rgba(255,255,255,.18);
}

.txBtn{
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--text);
  padding: 8px 12px;
  font-weight: 900;
  letter-spacing: .02em;
  cursor: pointer;
  user-select: none;
  min-width: 84px;
}
.txBtn.isOn{
  background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(22,163,74,.95));
  border-color: rgba(34,197,94,.55);
  box-shadow: 0 10px 22px rgba(34,197,94,.18), inset 0 1px 0 rgba(255,255,255,.20), inset 0 -3px 0 rgba(0,0,0,.35);
}

.infoHdr{
  margin-top: 14px;
  min-height: 22px;
  text-align: center;
  font-weight: 900;
  letter-spacing: .01em;
}

/* ---------- TOAST ---------- */
.toast{
  position: fixed;
  left: 50%;
  bottom: 86px;
  transform: translateX(-50%);
  background: rgba(0,0,0,.70);
  border: 1px solid rgba(255,255,255,.14);
  color: var(--text);
  padding: 10px 14px;
  border-radius: 12px;
  opacity: 0;
  pointer-events: none;
  transition: opacity .15s ease;
}
.toast.show{ opacity: 1; }

/* ---------- SMALL SCREEN TWEAKS ---------- */
@media (max-width: 420px){
  header{ gap: 10px; padding: 10px 12px; }
  .brandInstitutional{ letter-spacing: .22em; }
  .panel{ padding: 14px; }
}

/* === Fix r√©sum√©: pr√©server les retours de ligne et l'alignement === */
#summary{
  white-space: pre;           /* garde les
 */
  font-family: var(--mono);
  font-size: 14px;
  line-height: 1.35;
  tab-size: 2;
  overflow-x: auto;           /* √©vite le wrapping destructeur */
  -webkit-overflow-scrolling: touch;
  padding-bottom: 96px; /* keep last lines above bottom nav */
}

/* === Header: opaque black (requested) === */
header{
  background: #000 !important;
  backdrop-filter: none !important;
}

/* =====================================================
   Easter egg branding + arcade (hidden)
   - Open: 5 taps on GBAV (2s)
   ===================================================== */

/* √âquipement switch (LOC/GP) ‚Äî 5 taps ouvre l‚Äôarcade */
.equipSwitch{
  display:flex;
  gap:6px;
  padding:6px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  user-select:none;
  cursor: pointer;
}
.equipBtn{
  min-width: 56px;
  height: 40px;
  padding: 0 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.14);
  color: rgba(231,234,242,.90);
  font-family: var(--sans);
  font-weight: 900;
  letter-spacing: .02em;
  font-size: 16px;
}
.equipBtn:focus-visible{
  outline: 2px solid rgba(255,255,255,.35);
  outline-offset: 2px;
}
.equipBtn.isActive{
  border-color: rgba(255,255,255,.18);
  background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
}
.equipBtn.isOn{
  border-color: rgba(255,255,255,.24);
  background: linear-gradient(180deg, var(--btn), var(--btn2));
  color: #ffffff;
  box-shadow:
    0 10px 22px rgba(0,0,0,.38),
    inset 0 1px 0 rgba(255,255,255,.20);
}

/* Night theme: make LOC/GP selection impossible to miss */
body.theme-night .equipBtn{
  border-color: rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color: rgba(231,234,242,.88);
}
body.theme-night .equipBtn.isOn{
  background: linear-gradient(180deg, var(--btn), var(--btn2));
  color:#ffffff;
  border-color: rgba(0,0,0,.88);
  box-shadow:
    0 0 0 1px rgba(0,0,0,.92),
    0 0 18px rgba(45,108,223,.18),
    0 12px 28px rgba(0,0,0,.62),
    inset 0 1px 0 rgba(255,255,255,.16);
}
body.theme-night .equipSwitch{
  border-color: rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
}
body.theme-night .equipBtn{
  background: rgba(255,255,255,.05);
  border-color: rgba(255,255,255,.10);
}

/* Arcade overlay */
.arcadeOverlay{
  position: fixed;
  inset: 0;
  display: none;
  place-items: center;
  background: rgba(0,0,0,.72);
  z-index: 9999;
}
.arcadeOverlay.isOpen{ display: grid; }

.arcadeFrame{
  width: min(92vw, 420px);
  border-radius: 14px;
  background: #07090d;
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: 0 18px 60px rgba(0,0,0,.6);
  overflow: hidden;
}

.arcadeTop{
  display:flex;
  align-items:center;
  justify-content: space-between;
  padding: 10px 12px;
  background: #000;
  border-bottom: 1px solid rgba(255,255,255,.08);
}
.arcadeTitle{
  font-weight: 900;
  letter-spacing: .12em;
  font-size: 12px;
  color: rgba(230,235,242,.9);
  user-select:none;
}

#arcadeCanvas{
  display:block;
  width: 100%;
  height: auto;
  background: radial-gradient(circle at 50% 35%, #0c1a2b 0%, #05070b 60%, #000 100%);
  touch-action: none;
}

.arcadeHelp{
  padding: 10px 12px;
  font-size: 12px;
  color: rgba(230,235,242,.7);
  background: #000;
  border-top: 1px solid rgba(255,255,255,.06);
}

/* === FIX MOBILE: garder l‚Äôunit√© √† droite de l‚Äôinput (¬µA, dB, %) === */
.fieldLine{
  display: grid !important;
  grid-template-columns: 1fr auto;
  gap: 8px;
  align-items: center;
}
.fieldLine input{ width: 100%; }
.fieldLine .unit{
  }

/* Site/ID picker */
.siteRow{
  display:flex;
  gap:10px;
  align-items:stretch;
  justify-content:center;
}
.siteRow input{
  flex: 2 1 0;
  max-width:none !important;
  height: 44px;
}
.chooseBtn{
  flex: 1 1 0;
  min-width:0;
  height: 44px;
  padding: 0 10px;
}
.sitePickList{
  display:grid;
  gap:10px;
  margin-top: 10px;
}
.sitePickItem{
  border-radius: 12px;
  padding: 10px 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(231,234,242,.95);
  font-weight: 900;
  text-align:left;
}
.sitePickItem:active{ transform: translateY(1px); }
.sitePickItem.isActive{
  border-color: rgba(255, 80, 80, .55);
  background: rgba(255, 60, 60, .12);
}
.sitePickItem .muted{
  display:block;
  margin-top:4px;
  font-weight: 700;
  color: rgba(231,234,242,.70);
  font-size: 12px;
}
 white-space: nowrap; }

.topBlock{ text-align:center; }

/* --- Normes & limites (table) --- */
.normsBox{
  margin-top: 10px;
  padding: 14px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: color-mix(in srgb, var(--panel2) 84%, transparent);
}
/* CAT highlight in Limits & tolerances */
.catLine{
  text-align:center;
  margin: 6px 0 14px;
}
.catLine .catLabel{
  opacity:.85;
  font-weight:800;
}
.catLine .catValue{
  font-weight:1000;
  color:#fbbf24;
  letter-spacing:.5px;
}

.normTable{
  margin-top:10px;
  display:grid;
  grid-template-columns: 1.4fr .9fr .7fr .7fr;
  gap:8px 10px;
  align-items:center;
}
.ntHead{
  font-weight:900;
  opacity:.75;
  font-size:12px;
  padding-bottom:6px;
  border-bottom: 1px solid rgba(255,255,255,.10);
}
/* Centre l‚Äôen-t√™te de la colonne Statut */
.normTable .ntHead:nth-child(4){ text-align:center; }

.ntRowLbl{ font-weight:900; }
.ntRowVal, .ntRowTol, .ntRowSt{ opacity:.95; }

/* Statut (PASS/FAIL) ‚Äî centrage + couleurs */
.normTable .ntHead:nth-child(4){ text-align:center; }
.ntPass{ color: var(--ok, #22c55e); font-weight: 900; }
.ntFail{ color: var(--bad, #ef4444); font-weight: 900; }

.ntRowSt{
  text-align:center;
  font-weight:900;
}
/* Centre les en-t√™tes Diff√©rence / Tol√©rance / Statut */
.normTable .ntHead:nth-child(2),
.normTable .ntHead:nth-child(3),
.normTable .ntHead:nth-child(4){
  text-align: center;
}

/* Centre les valeurs sous Diff√©rence et Tol√©rance (comme Statut) */
.ntRowVal,
.ntRowTol{
  text-align: center;
}

/* ---------- R√âF√âRENCES (modal) ---------- */
.refOverlay{
  position: fixed;
  inset: 0;
  display: none;
  place-items: center;
  background: rgba(0,0,0,.72);
  z-index: 9998;
}
.refOverlay.isOpen{ display: grid; }

.refFrame{
  /* Plus grande (mobile-first) */
  width: min(98vw, 920px);
  height: 92vh;
  max-height: 92vh;

  display: flex;
  flex-direction: column;

  border-radius: 18px;
  background: color-mix(in srgb, var(--panel) 88%, #000 12%);

  /* Bordure noire demand√©e */
  border: 2px solid #000;

  box-shadow: 0 18px 60px rgba(0,0,0,.6);
  overflow: hidden;
}

.refTop{
  display:flex;
  align-items:center;
  justify-content:center; /* ‚úÖ titre centr√© */
  padding: 14px 12px;
  background: #000;
  border-bottom: 1px solid rgba(255,255,255,.10);
}
.refTitle{
  font-weight: 950;
  letter-spacing: .02em;
  font-size: 20px;       /* ‚úÖ plus gros */
  color: rgba(230,235,242,.92);
  user-select:none;
  text-align:center;
  width: 100%;
}
.refCloseBtn{
  flex: 0 0 auto;
  border-radius: 12px;
  padding: 10px 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(231,234,242,.95);
  font-weight: 900;
  box-shadow: none;
}
.refCloseBtn:active{ transform: translateY(1px); }


/* ---------- RESET CONFIRM (modal) ---------- */
.resetOverlay{
  position: fixed;
  inset: 0;
  display: none;
  place-items: center;
  background: rgba(0,0,0,.72);
  z-index: 9999;
}
.resetOverlay.isOpen{ display: grid; }

.resetFrame{
  width: min(92vw, 560px);
  border-radius: 18px;
  background: color-mix(in srgb, var(--panel) 88%, #000 12%);
  border: 2px solid #000;
  box-shadow: 0 18px 60px rgba(0,0,0,.70);
  padding: 18px 18px 16px;
}

.resetTitle{
  font-weight: 950;
  letter-spacing: .06em;
  text-transform: uppercase;
  margin: 2px 0 10px;
}

.resetMsg{
  color: var(--muted);
  line-height: 1.35;
  font-size: 14px;
}

.resetActions{
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 16px;
}
.resetActions button{
  flex: 0 0 auto;
  min-width: 140px;
}
@media (max-width: 520px){
  .resetMsg{ font-size: 13px; }
  .resetActions button{ min-width: 120px; }
}
.refText{
  flex: 1 1 auto;
  padding: 12px;
  white-space: normal;
  overflow-wrap: anywhere;
  font-family: var(--ui);
  font-size: 14px;
  line-height: 1.35;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

.refBottom{
  flex: 0 0 auto;
  padding: 12px;
  background: #000;
  border-top: 1px solid rgba(255,255,255,.10);
  display:flex;
  justify-content:center; /* ‚úÖ bouton au milieu */
}

.refCloseBottom{
  min-width: 160px;
  justify-content: center;
}

/* === Tableau des fr√©quences ILS (R√©f√©rences) === */
.refSectionTitle{
  font-family: var(--ui);
  font-weight: 800;
  letter-spacing: .2px;
  font-size: 15px;
  margin: 2px 0 10px;
  color: var(--ink);
}

.refGap{ height: 10px; }
.refMonoLine{ opacity: .85; }

.refTbl{
  width: 100%;
  table-layout: fixed;
  border-collapse: separate;
  border-spacing: 0;
  font-family: var(--ui);
  font-size: 14px;
  line-height: 1.25;
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 12px;
  overflow: hidden;
  background: rgba(0,0,0,.20);
}

.refTbl thead th{
  background: rgba(255,255,255,.06);
  color: var(--ink);
  font-weight: 800;
  padding: 10px 10px;
  text-align: left;
  border-bottom: 1px solid rgba(255,255,255,.10);
}

.refTbl td{
  padding: 10px 10px;
  border-bottom: 1px solid rgba(255,255,255,.08);
  color: var(--ink);
}

/* Le conteneur R√©f√©rences force overflow-wrap:anywhere;
   on annule pour le tableau afin d'√©viter les coupures au milieu des mots. */
.refTbl th,
.refTbl td{
  overflow-wrap: normal;
  word-break: normal;
  hyphens: auto;
}

/* Largeurs + alignement pour une lecture plus ‚Äúpro‚Äù */
.refTbl th:nth-child(1),
.refTbl td:nth-child(1){ width: 44%; }
.refTbl th:nth-child(2),
.refTbl td:nth-child(2){ width: 28%; text-align: center; }
.refTbl th:nth-child(3),
.refTbl td:nth-child(3){ width: 28%; text-align: center; }


.refTbl tbody tr:last-child td{ border-bottom: none; }

.refTbl td:nth-child(2),
.refTbl td:nth-child(3),
.refTbl th:nth-child(2),
.refTbl th:nth-child(3){
  white-space: nowrap;
}

.refTbl .na{
  opacity: .75;
  font-style: italic;
}

.refHr{
  height: 1px;
  background: rgba(255,255,255,.10);
  margin: 14px 0 12px;
}


  .refNotesOnly{padding:12px 14px; font-size:14px; opacity:.9;}
.refPre{
  margin: 0;
  white-space: pre-wrap;
  overflow-wrap: anywhere;
  font-family: var(--mono);
  font-size: 14px;
  line-height: 1.35;
  color: var(--ink);
}


/* === R√©f√©rences (appui long Home) ‚Äî FIX: fen√™tre plus grande + bloque les gestes arri√®re-plan === */
body.modalOpen{
  overflow:hidden !important;
  touch-action:none;               /* bloque les gestes sur l'arri√®re-plan */
}

/* Overlay plein √©cran */
.refOverlay{
  position:fixed !important;
  inset:0 !important;
  z-index:99999 !important;
  padding:12px !important;
  background:rgba(0,0,0,.60) !important;
  display:none;
  align-items:center;
  justify-content:center;
  overscroll-behavior:contain;
}
.refOverlay.isOpen{ display:flex !important; }

/* Fen√™tre (plus grande) + bordure noire */
.refFrame{
  width:min(980px, 98vw) !important;
  height:92vh !important;
  max-height:92vh !important;
  border:2px solid #000 !important;  /* ‚úÖ bordure noire */
  border-radius:18px !important;
  overflow:hidden !important;
  box-shadow:0 30px 90px rgba(0,0,0,.65) !important;
}

/* Zone texte scrollable ‚Äî vertical seulement */
.refText{
  height:calc(92vh - 64px) !important; /* ~ hauteur header */
  overflow:auto !important;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  touch-action:pan-y;                 /* autorise scroll vertical */
}

@media (max-width:520px){
  .refFrame{ height:94vh !important; max-height:94vh !important; }
  .refText{ height:calc(94vh - 64px) !important; }
}


/* ---------- MOBILE COMPACT (reduce top/bottom chrome in APK) ----------
   Placed at end so it overrides the base layout on small screens.
--------------------------------------------------------------------- */
@media (max-width: 430px), (max-height: 760px){
  :root{ --headIcon:48px; }

  header{ padding:10px 12px; gap:12px; }

  .brandQuad{ border-radius:16px; }
  .themeToggle{ border-radius:16px; font-size:20px; }

/* Bottom nav smaller + respects gesture bar */
  .btnRow{
    gap:10px;
    padding:10px 12px calc(10px + max(env(safe-area-inset-bottom, 0px), 48px));
  }
  .btnRow .navBtn{
    padding:12px 12px;
    font-size:14px;
    border-radius:14px;
  }
  .btnRow .homeBtn{
    flex: 0 0 48px;
    width: 48px;
    height: 48px;
    border-radius:16px;
  }
  .btnRow .homeBtn svg{ width:20px; height:20px; }

  /* Keep content clear of the fixed bottom nav */
  .wrap{ padding: calc(12px + var(--headerH)) 12px calc(96px + env(safe-area-inset-bottom)); }
}


/* ---------- OVERFLOW GUARD (anti-d√©bordement mobile) ---------- */
html, body{
  width:100%;
  max-width:100%;
  overflow-x:hidden;
}

/* Permettre aux items de shrink correctement (sinon la grille/flex d√©borde) */
.headerCenter,
.wrap,
.panel,
.refFrame,
.arcadeFrame,
.btnRow{
  min-width:0;
  max-width:100%;
}

.headerCenter,
.secTitle,
.consignDesc,
.pill,
.ntRowLbl,
.ntHead{
  overflow-wrap:anywhere;
  word-break:break-word;
}

/* Champs: grid qui peut shrink (sinon l'input force un d√©bordement) */
.fieldLine{
  grid-template-columns: minmax(0,1fr) auto;
}
.fieldLine input,
.fieldLine textarea,
.fieldLine select{
  min-width:0;
  max-width:100%;
}

/* Tables/grilles: autoriser le wrap et le shrink */
.normTable{
  grid-template-columns:
    minmax(0,1.4fr)
    minmax(0,.9fr)
    minmax(0,.7fr)
    minmax(0,.7fr);
}
.normTable > div{
  min-width:0;
}

/* Groupes de boutons: wrap si l'√©cran est petit (ou police grosse) */
.catGroup,
.txChoice,
.equipGroup{
  flex-wrap:wrap;
}


/* === UI FIXES (space + table header fit + ¬µA) === */
.main{
  padding-top: calc(var(--head-h) + 8px) !important;
  padding-bottom: calc(var(--foot-h) + 8px) !important;
}

/* Tighten overall vertical spacing between blocks */
.section{
  margin-top: 10px !important;
  margin-bottom: 10px !important;
}
.card{
  padding-top: 14px !important;
  padding-bottom: 14px !important;
}

/* Table header: smaller font and no wrap */
.tableHead th{
  font-size: 12px !important;
  line-height: 1.1 !important;
  white-space: nowrap !important;
  padding: 10px 10px !important;
}

/* Mobile: even tighter */
@media (max-width: 780px){
  .main{
    padding-top: calc(var(--head-h) + 6px) !important;
    padding-bottom: calc(var(--foot-h) + 6px) !important;
  }
  .tableHead th{
    font-size: 11px !important;
    padding: 9px 8px !important;
  }
}

/* =========================================================
   NUMBER PICKER (drum/wheel picker pour saisie num√©rique)
   ========================================================= */
.pickerOverlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  z-index:9999;
  align-items:flex-end;
  justify-content:center;
  animation: fadeIn .25s ease-out;
}
.pickerOverlay.isOpen{
  display:flex;
}

.pickerFrame{
  background:var(--panel);
  border-radius:var(--r) var(--r) 0 0;
  width:100%;
  max-width:480px;
  box-shadow:var(--shadow);
  animation: slideUp .3s cubic-bezier(0.16, 1, 0.3, 1);
  padding-bottom:env(safe-area-inset-bottom);
}

@keyframes fadeIn{
  from{ opacity:0; }
  to{ opacity:1; }
}
@keyframes slideUp{
  from{ transform:translateY(100%); }
  to{ transform:translateY(0); }
}


@keyframes fadeOut{
  from{ opacity:1; }
  to{ opacity:0; }
}
@keyframes slideDown{
  from{ transform:translateY(0); }
  to{ transform:translateY(100%); }
}

.pickerOverlay.isClosing{
  animation: fadeOut .20s ease-in forwards;
}
.pickerOverlay.isClosing .pickerFrame{
  animation: slideDown .22s cubic-bezier(0.4, 0, 1, 1) forwards;
}

/* Smoother snap (disabled during drag via JS) */
.pickerDrumInner{
  transition:transform .22s cubic-bezier(0.16, 1, 0.3, 1);
  will-change:transform;
}

.pickerTop{
  padding:16px 20px;
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
}
.pickerTop > div{width:100%;}


.pickerTitle{
  font-size:18px;
  font-weight:700;
  color:var(--text);
}

.pickerLabel{
  font-size:14px;
  color:var(--muted);
  margin-top:4px;
}

.pickerMain{
  padding:24px 20px;
  display:flex;
  flex-direction:column;
  gap:20px;
}

.pickerDrums{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:8px;
  position:relative;
  height:200px;
  margin:0 auto;
}

/* Masque de s√©lection (ligne centrale) */
.pickerDrums::before{
  content:"";
  position:absolute;
  left:0;
  right:0;
  top:50%;
  transform:translateY(-50%);
  height:44px;
  background:rgba(255,255,255,.05);
  border-top:1px solid var(--line);
  border-bottom:1px solid var(--line);
  pointer-events:none;
  z-index:1;
}

.pickerDrum{
  position:relative;
  height:200px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

.pickerDrumInner{
  display:flex;
  flex-direction:column;
  transition:transform .22s cubic-bezier(0.16, 1, 0.3, 1);
  will-change:transform;
  padding:78px 0; /* Centre le item s√©lectionn√© */
}

.pickerItem{
  height:44px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  font-weight:600;
  color:var(--muted);
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
  transition:color .15s, opacity .15s;
}

.pickerItem.isSelected{
  color:var(--text);
  font-weight:700;
}

/* Fade sur les bords */
.pickerDrum::before,
.pickerDrum::after{
  content:"";
  position:absolute;
  left:0;
  right:0;
  height:78px;
  pointer-events:none;
  z-index:2;
}
.pickerDrum::before{
  top:0;
  background:linear-gradient(to bottom, var(--panel), transparent);
}
.pickerDrum::after{
  bottom:0;
  background:linear-gradient(to top, var(--panel), transparent);
}

/* Largeurs des colonnes */
.pickerDrum.sign{ width:50px; }
.pickerDrum.digit{ width:48px; }
.pickerDrum.decimal{ width:28px; }

.pickerDrum.decimal .pickerItem{
  font-size:28px;
  font-weight:400;
}

.pickerButtons{
  display:flex;
  gap:12px;
  padding:0 20px 20px;
}

.pickerBtn{
  flex:1;
  height:52px;
  border-radius:12px;
  font-size:16px;
  font-weight:600;
  border:none;
  cursor:pointer;
  transition:all .2s;
}

.pickerBtn.cancel{
  background:var(--panel2);
  color:var(--text);
}
.pickerBtn.cancel:hover{
  background:var(--line);
}

.pickerBtn.ok{
  background:var(--btn);
  color:#fff;
}
.pickerBtn.ok:hover{
  background:var(--btn2);
}

/* Preview de la valeur */
.pickerPreview{
  text-align:center;
  font-size:48px;
  font-weight:700;
  color:var(--text);
  font-variant-numeric:tabular-nums;
  letter-spacing:-0.02em;
  min-height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.pickerUnit{
  font-size:24px;
  color:var(--muted);
  margin-left:8px;
  font-weight:400;
}



/* Summary page actions (single centered button) */
.summaryActions{
  display:flex;
  justify-content:center;
  margin-top:12px;
}
.primaryWide{
  width:min(420px, 92%);
}

/* Summary header with compact copy button (top-right) */
.summaryHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:10px;
}
.copyIconBtn{
  flex:0 0 auto;
  padding:0;
  width:40px;
  height:40px;
  min-width:40px;
  line-height:1;
  border-radius:16px;
  font-size:20px;
  border:1px solid rgba(255,255,255,.16);
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
  color:var(--text);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 10px 26px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.08);
  cursor:pointer;
}


/* Mini bouton d'ouverture du picker (cohabite avec saisie clavier) */
.pickerIconBtnField{
  flex:0 0 auto !important;
  padding:0 !important;
  width:36px;
  height:36px;
  min-width:36px;
  border-radius:14px;
  line-height:1;
  font-size:18px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.14);
  color: rgba(231,234,242,.92);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.pickerIconBtnField:hover{ filter: brightness(1.06); }
.pickerIconBtnField:active{ transform: translateY(1px); }

/* Assure un alignement propre input + unit√© + picker */
.fieldLine{
  align-items:center;
}
.copyIconBtn:active{ transform:translateY(1px); }
.copyIconBtn:disabled{ opacity:.5; cursor:not-allowed; }
@media (max-width:520px){
  .copyIconBtn{ width:36px; height:36px; min-width:36px; border-radius:14px; font-size:18px; }
}

</style>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#05070A">

  <script>
    // Robust top inset handling (Android PWA/WebView + iOS safe-area)
    (function(){
      function setTopInset(){
        var top = 0;
        var vv = window.visualViewport;

        if (vv && typeof vv.offsetTop === "number") {
          top = Math.max(0, Math.round(vv.offsetTop));
        }

        // Fallback: keep whatever CSS env() provides (often iOS)
        // If Android returns 0, CSS default still covers iOS notch.
        document.documentElement.style.setProperty("--vvTop", top + "px");
      }

      window.addEventListener("resize", setTopInset, {passive:true});
      window.addEventListener("orientationchange", setTopInset, {passive:true});
      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", setTopInset, {passive:true});
      }
      setTopInset();
    })();

    // Service Worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function(){
        navigator.serviceWorker.register("./sw.js").catch(console.error);
      });
    }
  </script>

</head>
<body class="theme-day">
<!-- ==========================
     SITE PICKER ‚Äî bouton "Choisir" (Home)
     ===================================================== -->
<div id="siteOverlay" class="refOverlay" aria-hidden="true">
  <div class="refFrame" role="dialog" aria-label="Site picker">
    <div class="refTop">
      <div class="refTitle" data-i18n="Choisir un site">Choisir un site</div>
    </div>

    <div class="refText">
      <div id="sitePickList" class="sitePickList"></div>
    </div>

    <div class="refBottom">
      <button id="siteClose" class="refCloseBtn refCloseBottom" type="button" aria-label="Fermer" data-i18n="Fermer">Fermer</button>
    </div>
  </div>
</div>


<!-- =====================================================
     HEADER ‚Äî Logo, titres, barre de progression
     ===================================================== -->
<header>
  <!-- LEFT: logo GBAV + Easter egg (5 taps) -->
  <div class="headerLeft">
    <div class="brandQuad" aria-label="GBAV">
      <svg class="gbavLogo" viewBox="0 0 64 64" role="img" aria-label="GBAV">
      <defs>
        <linearGradient id="gShine" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="rgba(255,255,255,.20)"/>
          <stop offset="1" stop-color="rgba(255,255,255,0)"/>
        </linearGradient>
      </defs>

      <!-- Outer rounded square -->
      <rect x="4.5" y="4.5" width="55" height="55" rx="14" fill="none" stroke="currentColor" stroke-width="2" opacity=".55"/>
      <rect x="6.5" y="6.5" width="51" height="51" rx="13" fill="none" stroke="currentColor" stroke-width="1.5" opacity=".22"/>

      <!-- Main disk -->
      <circle cx="32" cy="32" r="22" fill="none" stroke="currentColor" stroke-width="2.2" opacity=".85"/>
      <circle cx="32" cy="32" r="20" fill="none" stroke="currentColor" stroke-width="1.2" opacity=".20"/>

      <!-- Crosshair -->
      <line x1="32" y1="18" x2="32" y2="46" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".9"/>
      <line x1="18" y1="32" x2="46" y2="32" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".9"/>

      <!-- Center ring -->
      <circle cx="32" cy="32" r="7" fill="none" stroke="currentColor" stroke-width="2.4" opacity=".95"/>

      <!-- Dots (axes) -->
      <g fill="currentColor" opacity=".95">
        <!-- up -->
        <circle cx="32" cy="12" r="2.2"/>
        <circle cx="32" cy="20" r="2.2"/>
        <!-- down -->
        <circle cx="32" cy="44" r="2.2"/>
        <circle cx="32" cy="52" r="2.2"/>
        <!-- left -->
        <circle cx="12" cy="32" r="2.2"/>
        <circle cx="20" cy="32" r="2.2"/>
        <!-- right -->
        <circle cx="44" cy="32" r="2.2"/>
        <circle cx="52" cy="32" r="2.2"/>
      </g>

      <!-- Small notch block -->
      <rect x="43" y="22" width="13" height="8" rx="1.8" fill="none" stroke="currentColor" stroke-width="1.8" opacity=".28"/>

      <!-- subtle shine -->
      <path d="M10 10 C22 6, 42 6, 54 14" fill="none" stroke="url(#gShine)" stroke-width="4" stroke-linecap="round" opacity=".9"/>
    </svg></div>
  </div>

  <!-- CENTER: titre + sous-titre + progression -->
  <div class="headerCenter">
    <div class="titleLine">
      <h1>ILS Normac - Mod√®le A/B</h1>
    <div class="sub">Lectures de piste & GBAV</div>
    </div>
    

</div>

  <!-- RIGHT: th√®me (ic√¥ne seule) -->
  <button id="themeToggle" class="themeToggle" type="button" aria-label="Changer le th√®me">
    <span class="ttIcon" aria-hidden="true">üåô</span>
  </button>
</header>

<!-- =====================================================
     APP ‚Äî Conteneur principal
     - #main est rempli par JavaScript selon l‚Äô√©tape courante
     ===================================================== -->
<div class="wrap">
  <div class="panel" id="main"></div>
</div>

<!-- =====================================================
     NAVIGATION ‚Äî Boutons + swipe (g√©r√© en JS)
     ===================================================== -->
<div class="btnRow">
  <button class="navBtn secondary" id="btnPrev">‚óÄ Pr√©c√©dent</button>
  <button class="navBtn homeBtn" id="btnHome" aria-label="Accueil" title="Accueil">
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M12 3.1 2.7 11a1 1 0 0 0 1.3 1.5l1-.8V20a1.5 1.5 0 0 0 1.5 1.5H10a1 1 0 0 0 1-1v-5h2v5a1 1 0 0 0 1 1h3.5A1.5 1.5 0 0 0 19 20v-8.3l1 .8A1 1 0 1 0 21.3 11L12 3.1z"/>
    </svg>
  </button>
  <button class="navBtn navNext" id="btnNext">Suivant ‚ñ∂</button>
</div>

<!-- =====================================================
     TOAST ‚Äî Confirmations rapides (copie, etc.)
     ===================================================== -->
<div class="toast" id="toast">Copi√© ‚úÖ</div>

<!-- =====================================================
     R√âF√âRENCES ‚Äî Long press sur le bouton Home
     ===================================================== -->
<div id="refOverlay" class="refOverlay" aria-hidden="true">
  <div class="refFrame" role="dialog" aria-label="R√©f√©rences">
    <div class="refTop">
      <div class="refTitle">R√©f√©rences</div>
    </div>
    <div id="refText" class="refText">
    <div class="refSection">
      <div class="refSectionTitle">ILS ‚Äî Fr√©quences d‚Äôop√©ration</div>
      <table class="refTbl" aria-label="ILS frequencies table">
        <thead>
          <tr>
            <th>Site</th>
            <th>LOC (VHF)</th>
            <th>GP (UHF)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Baie-Comeau (IBC)</td><td>110.30 MHz</td><td>335.00 MHz</td></tr>
          <tr><td>Gasp√© (IGP)</td><td>109.90 MHz</td><td class="na">n/a</td></tr>
          <tr><td>√éle-de-la-Madeleine (IGR)</td><td>110.10 MHz</td><td class="na">n/a</td></tr>
          <tr><td>Mont-Joli (IYY)</td><td>109.70 MHz</td><td class="na">n/a</td></tr>
          <tr><td>Qu√©bec (IQB)</td><td>109.50 MHz</td><td>332.60 MHz</td></tr>
          <tr><td>Sept-√éles (IZV)</td><td>111.30 MHz</td><td>332.30 MHz</td></tr>
          <tr><td>St-Augustin (IIF)</td><td>109.10 MHz</td><td class="na">n/a</td></tr>
        </tbody>
      </table>
    </div>

    <div class="refHr"></div>
    <div class="refNotesOnly mono" id="refNotesOnly">Notes...</div>
    </div>
    <div class="refBottom">
      <button id="refClose" class="refCloseBtn refCloseBottom" type="button" aria-label="Fermer">Fermer</button>
    </div>
  
</div>
</div>

<!-- =====================================================
     RESET CONFIRM (modal)
     ===================================================== -->
<div id="resetOverlay" class="resetOverlay" aria-hidden="true">
  <div class="resetFrame" role="dialog" aria-label="Reset confirmation">
    <div class="resetTitle" id="resetTitle">R√©initialiser</div>
    <div class="resetMsg" id="resetMsg">Cette action efface tous les champs sauvegard√©s sur cet appareil.</div>
    <div class="resetActions">
      <button id="resetCancel" type="button" class="secondary">Annuler</button>
      <button id="resetConfirm" type="button" class="danger">Tout effacer</button>
    </div>
  </div>
</div>

<!-- Number Picker Overlay -->
<div id="numberPicker" class="pickerOverlay" aria-hidden="true">
  <div class="pickerFrame" role="dialog" aria-label="S√©lecteur de nombre">
    <div class="pickerTop">
      <div>
        <div class="pickerTitle" id="pickerTitle">Entrer la valeur</div>
        <div class="pickerLabel" id="pickerLabel"></div>
      </div>
    </div>
    
    <div class="pickerMain">
      <div class="pickerPreview" id="pickerPreview">
        <span id="pickerValue">0.0</span>
        <span class="pickerUnit" id="pickerUnit">¬µA</span>
      </div>
      
      <div class="pickerDrums" id="pickerDrums">
        <!-- Les colonnes seront g√©n√©r√©es dynamiquement par JS -->
      </div>
    </div>
    
    <div class="pickerButtons">
      <button type="button" class="pickerBtn cancel" id="pickerCancel">Annuler</button>
      <button type="button" class="pickerBtn ok" id="pickerOk">OK</button>
    </div>
  </div>
</div>

<script>
/* =========================================================
   JavaScript ‚Äî Logique de l‚Äôapplication
   - State (valeurs, √©tape courante)
   - Auto-save (localStorage)
   - Navigation (boutons + swipe)
   - Rendu (construction HTML des √©tapes)
   - G√©n√©ration du r√©sum√© + copie
   ========================================================= */

(() => {

/* =========================================================
   NUMBER PICKER ‚Äî Drum/wheel style pour saisie num√©rique
   ========================================================= */
const NumberPicker = (() => {
  let currentInput = null;
  let currentCallback = null;
  let drums = {
    sign: null,
    tens: null,
    units: null,
    decimal: null,
    tenths: null,
    hundredths: null
  };
  
  const overlay = document.getElementById('numberPicker');
  const drumsContainer = document.getElementById('pickerDrums');
  const valueDisplay = document.getElementById('pickerValue');
  const unitDisplay = document.getElementById('pickerUnit');
  const titleDisplay = document.getElementById('pickerTitle');
  const labelDisplay = document.getElementById('pickerLabel');
  const cancelBtn = document.getElementById('pickerCancel');
  const okBtn = document.getElementById('pickerOk');
  
  // Configuration par d√©faut
  let config = {
    defaultValue: 0,
    unit: '¬µA',
    title: 'Entrer la valeur',
    label: '',
    decimals: 1,          // 1 = x.x, 2 = x.xx (SDM only)
    min: -99.99,
    max: 99.99,
    allowNegative: true,
    lockedSign: null
  };
  
  function init() {
    cancelBtn.addEventListener('click', close);
    okBtn.addEventListener('click', confirm);

    // Haptique l√©g√®re (optionnelle) pour un feeling "app native"
    const haptic = (ms = 8) => { try{ if (navigator.vibrate) navigator.vibrate(ms); }catch(e){} };
    overlay.__haptic = haptic;

    // ESC ferme le picker + focus trap (TAB)
    overlay.addEventListener('keydown', (e) => {
      if (!overlay.classList.contains('isOpen')) return;
      if (e.key === 'Escape') { e.preventDefault(); close(); return; }

      if (e.key === 'Tab') {
        const focusables = overlay.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
        if (!focusables.length) return;
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (e.shiftKey) {
          if (document.activeElement === first) { e.preventDefault(); last.focus(); }
        } else {
          if (document.activeElement === last) { e.preventDefault(); first.focus(); }
        }
      }
    });
    
    // Fermer si clic sur l'overlay
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) close();
    });
  }
  
  function createDrum(type, values, selectedIndex) {
    const drum = document.createElement('div');
    drum.className = `pickerDrum ${type}`;
    
    const inner = document.createElement('div');
    inner.className = 'pickerDrumInner';
    
    values.forEach((val, idx) => {
      const item = document.createElement('div');
      item.className = 'pickerItem';
      if (idx === selectedIndex) item.classList.add('isSelected');
      item.textContent = val;
      item.dataset.value = val;
      item.dataset.index = idx;
      inner.appendChild(item);
    });
    
    drum.appendChild(inner);
    
    // Positionner au centre
    updateDrumPosition(inner, selectedIndex);
    
    // Gestion des √©v√©nements
    let touchStartY = 0;
    let currentY = 0;
    let isDragging = false;
    
    const startDrag = (y) => {
      isDragging = true;
      touchStartY = y;
      currentY = parseInt(inner.style.transform.match(/-?\d+/)?.[0] || 0);
    };
    
    const moveDrag = (y) => {
      if (!isDragging) return;
      const delta = y - touchStartY;
      const newY = currentY + delta;
      inner.style.transform = `translateY(${newY}px)`;
    };
    
    const endDrag = () => {
      if (!isDragging) return;
      isDragging = false;
      // Re-enable snap animation
      inner.style.transition = 'transform .22s cubic-bezier(0.16, 1, 0.3, 1)';

      // Snap to nearest item
      const offset = parseInt(inner.style.transform.match(/-?\d+/)?.[0] || 0);
      const itemHeight = 44;
      const index = Math.round(-offset / itemHeight);
      const clampedIndex = Math.max(0, Math.min(values.length - 1, index));
      
      updateDrumPosition(inner, clampedIndex);
      updateValue();
      try{ overlay.__haptic && overlay.__haptic(8); }catch(e){}
    };
    
    // Touch events
    drum.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startDrag(e.touches[0].clientY);
    });
    
    drum.addEventListener('touchmove', (e) => {
      e.preventDefault();
      moveDrag(e.touches[0].clientY);
    });
    
    drum.addEventListener('touchend', endDrag);
    
    // Mouse events pour desktop
    drum.addEventListener('mousedown', (e) => {
      e.preventDefault();
      startDrag(e.clientY);
    });
    
    document.addEventListener('mousemove', (e) => {
      if (isDragging && drum.contains(e.target)) {
        moveDrag(e.clientY);
      }
    });
    
    document.addEventListener('mouseup', () => {
      if (isDragging) endDrag();
    });
    
    // Click direct sur un item
    inner.querySelectorAll('.pickerItem').forEach((item, idx) => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        inner.style.transition = 'transform .22s cubic-bezier(0.16, 1, 0.3, 1)';
        updateDrumPosition(inner, idx);
        updateValue();
        try{ overlay.__haptic && overlay.__haptic(8); }catch(e){}
      });
    });
    
    return drum;
  }
  
  function updateDrumPosition(inner, index) {
    const itemHeight = 44;
    const offset = -index * itemHeight;
    inner.style.transform = `translateY(${offset}px)`;
    
    // Update selected class
    inner.querySelectorAll('.pickerItem').forEach((item, idx) => {
      item.classList.toggle('isSelected', idx === index);
    });
  }
  
  function getSelectedValue(drum) {
    const selected = drum.querySelector('.pickerItem.isSelected');
    return selected ? selected.dataset.value : '0';
  }
  
  function updateValue() {
    const decimals = (config && Number.isFinite(config.decimals)) ? config.decimals : 1;

    let sign = drums.sign ? getSelectedValue(drums.sign) : '';
    let tens = drums.tens ? getSelectedValue(drums.tens) : '0';
    let units = drums.units ? getSelectedValue(drums.units) : '0';
    let tenths = drums.tenths ? getSelectedValue(drums.tenths) : '0';
    let hundredths = drums.hundredths ? getSelectedValue(drums.hundredths) : '0';

    let value = (sign === '‚àí') ? '-' : '';
    const allZero = (tens === '0' && units === '0' && tenths === '0' && (decimals === 1 || hundredths === '0'));

    if (allZero) {
      value += (decimals === 2) ? '0.00' : '0.0';
    } else {
      if (tens !== '0') value += tens;
      value += units + '.';
      value += tenths;
      if (decimals === 2) value += hundredths;
    }

    valueDisplay.textContent = value;
  }
  
  function parseValue(val) {
    const num = parseFloat(String(val).replace(',', '.')) || 0;
    const isNegative = num < 0;
    // On limite √† 2 chiffres avant la d√©cimale (centaines inutiles)
    const absNum = Math.min(99.99, Math.abs(num));

    const tens = Math.floor(absNum / 10) % 10;
    const units = Math.floor(absNum) % 10;
    const tenths = Math.floor((absNum * 10) % 10);
    const hundredths = Math.floor((absNum * 100) % 10);

    return {
      sign: isNegative ? '‚àí' : '+',
      tens,
      units,
      tenths,
      hundredths
    };
  }
  
  function open(options = {}) {
    config = { ...config, ...options };
    
    titleDisplay.textContent = (lang === 'fr' ? 'Entrer la valeur' : 'Enter value');
    labelDisplay.textContent = config.label;
    unitDisplay.textContent = (config.unit || '').replace(/[+\-¬±]/g,'').trim();
    
    // Parse la valeur initiale
    const parsed = parseValue(config.defaultValue);
    
    // Clear drums
    drumsContainer.innerHTML = '';
    drums = {};
    
    // Cr√©er les colonnes
    const locked = (config.lockedSign === '+' || config.lockedSign === '‚àí');
    if (locked) parsed.sign = config.lockedSign;

    if (config.allowNegative || locked) {
      const signValues = ['+', '‚àí'];
      const signIndex = parsed.sign === '‚àí' ? 1 : 0;
      drums.sign = createDrum('sign', signValues, signIndex);
      // Si signe verrouill√©, emp√™cher toute interaction
      if (locked) {
        drums.sign.classList.add('isLocked');
        drums.sign.style.pointerEvents = 'none';
      }
      drumsContainer.appendChild(drums.sign);
    }

    // Chiffres (0-9)
    const digitValues = ['0','1','2','3','4','5','6','7','8','9'];
    const decimals = (config && Number.isFinite(config.decimals)) ? config.decimals : 1;

    // Dizaines
    drums.tens = createDrum('digit', digitValues, parsed.tens);
    drumsContainer.appendChild(drums.tens);

    // Unit√©s
    drums.units = createDrum('digit', digitValues, parsed.units);
    drumsContainer.appendChild(drums.units);

    // Point d√©cimal (fixe)
    const decimalDrum = document.createElement('div');
    decimalDrum.className = 'pickerDrum decimal';
    decimalDrum.innerHTML = '<div class="pickerDrumInner" style="transform:translateY(0)"><div class="pickerItem isSelected">.</div></div>';
    drumsContainer.appendChild(decimalDrum);

    // Dixi√®mes
    drums.tenths = createDrum('digit', digitValues, parsed.tenths);
    drumsContainer.appendChild(drums.tenths);

    // Centi√®mes (SDM seulement)
    if (decimals === 2) {
      drums.hundredths = createDrum('digit', digitValues, parsed.hundredths);
      drumsContainer.appendChild(drums.hundredths);
    }

    // Afficher la valeur initiale
    updateValue();
    
    // Ouvrir l'overlay
    overlay.classList.remove('isClosing');
    overlay.classList.add('isOpen');
    overlay.setAttribute('aria-hidden', 'false');
    try{ overlay.focus(); }catch(e){}
    try{ okBtn && okBtn.focus(); }catch(e){}
  }
  
  function close() {
    if (!overlay.classList.contains('isOpen')) return;
    overlay.classList.add('isClosing');
    overlay.setAttribute('aria-hidden', 'true');
    // Let the CSS animation play
    setTimeout(() => {
      overlay.classList.remove('isOpen');
      overlay.classList.remove('isClosing');
      currentInput = null;
      currentCallback = null;
    }, 220);
  }
  
  function confirm() {
    const value = valueDisplay.textContent;
    
    if (currentCallback) {
      currentCallback(value);
    }
    
    if (currentInput) {
      currentInput.value = value;
      // Trigger input event pour la sauvegarde auto
      currentInput.dispatchEvent(new Event('input', { bubbles: true }));
      currentInput.dispatchEvent(new Event('change', { bubbles: true }));
    }
    
    close();
  }
  
  function openForInput(input, options = {}) {
    currentInput = input;
    
    const currentValue = input.value || options.defaultValue || 0;
    
    open({
      ...options,
      defaultValue: currentValue,
      title: options.title || input.getAttribute('aria-label') || input.placeholder || 'Entrer la valeur'
    });
  }
  
  init();
  
  return {
    open,
    openForInput,
    close
  };
})();

  const STORAGE_KEY = 'ILS_READINGS_V1';
  const APP_VERSION = 'v1.1'; // bump this when you publish

// === i18n (FR/EN) + UI relabeling ===
const LANG_KEY = "ILS_LANG_V1";
let lang = (localStorage.getItem(LANG_KEY) || "en").toLowerCase();
if (lang !== "en" && lang !== "fr") lang = "en";
document.documentElement.setAttribute("lang", lang);

const I18N_EN = {
  // Header
  "ILS Normac - Mod√®le A/B": "ILS Normac - Model A/B",
  "Lectures de piste & GBAV": "Runway readings & GBAV",

  // Nav
  "‚óÄ Pr√©c√©dent": "‚óÄ Previous",
  "Suivant ‚ñ∂": "Next ‚ñ∂",
  "VOIR R√âSUM√â": "VIEW SUMMARY",
  "Voir r√©sum√©": "View summary",
  "Accueil": "Home",

  "R√©f√©rences": "References",
  "Fermer": "Close",
  "ILS ‚Äî Fr√©quences d‚Äôop√©ration": "ILS ‚Äî Operating frequencies",
  "Fr√©quence LOC (VHF)": "LOC frequency (VHF)",
  "Fr√©quence GP (UHF)": "GP frequency (UHF)",
  "LOC ‚Äî Fr√©quences d‚Äôop√©ration (plage g√©n√©rale)": "LOC ‚Äî Operating range (general)",
  "GP ‚Äî Fr√©quences d‚Äôop√©ration (plage g√©n√©rale)": "GP ‚Äî Operating range (general)",
  "‚Ä¢ 329.15 √† 335.00 MHz (canaux ILS GP)": "‚Ä¢ 329.15 to 335.00 MHz (ILS GP channels)",
  "‚Ä¢ Pairage avec GP selon canal ILS": "‚Ä¢ Paired with GP per ILS channel",
  "‚Ä¢ 108.10 √† 111.95 MHz (canaux ILS LOC, 50 kHz)": "‚Ä¢ 108.10 to 111.95 MHz (ILS LOC channels, 50 kHz)",
  "GP absent √† certains sites : valeur affich√©e = n/a": "Some sites have no GP: shown as n/a",
  "Remplace/compl√®te ce bloc avec tes extraits ‚Äúnormes‚Äù (par. 3, etc.)": "Replace/complete this block with your standard excerpts (section 3, etc.)",
  "Tu peux aussi mettre des tol√©rances CAT I/II/III, alarm limits, etc.": "You can also add CAT I/II/III tolerances, alarm limits, etc.",

  // Home / setup
  "Infos (optionnelles)": "Info (optional)",

  "Configuration normale.": "Normal configuration.",
  "Brancher le PIR dans le c√¢ble NF.": "Connect the PIR to the NF cable.",
  "Lire et consigner la DDM mesur√©e au PIR.": "Read and record the DDM measured at the PIR.",
  "Alarme position 150 Hz: Flight check F4 ‚Üí CL test signal 1.": "150 Hz position alarm: Flight check F4 ‚Üí CL test signal 1.",
  "Alarme position 90 Hz: Flight check F4 ‚Üí CL test signal 2.": "90 Hz position alarm: Flight check F4 ‚Üí CL test signal 2.",
  "But: lecture PIR correspond √† DDM FSC du moniteur (F5), mais en d√©tection inverse (pr√©dominant 90 Hz).": "Goal: PIR reading matches the monitor FSC DDM (F5), but with inverse detection (90 Hz predominant).",
  "90Hz corrig√© = DDM 90Hz - ŒîCL": "Corrected 90Hz = 90Hz DDM - ŒîCL",
  "150Hz corrig√© = DDM 150Hz - ŒîCL": "Corrected 150Hz = 150Hz DDM - ŒîCL",
  "Changer le th√®me": "Change theme",
  "Erreur lors du chargement des donn√©es:": "Error while loading data:",
  "√âquipement (LOC/GP)": "Equipment (LOC/GP)",
  "√âtape": "Step",
  "Site": "Site",
  "Site/ID": "Site/ID",
  "ID": "ID",
  "TI": "TI",
  "Normes et limites": "Limits & tolerances",
  "Cat√©gorie ILS :": "ILS category:",
  "Param√®tre": "Parameter",
  "Diff√©rence": "Difference",
  "Tol√©rance": "Tolerance",
  "Statut": "Status",

  // Common buttons / labels
  "Effacer": "Clear",
  "R√©initialiser": "Reset",
  "Annuler": "Cancel",
  "Tout effacer": "Erase",
  "Cette action efface tous les champs sauvegard√©s sur cet appareil.": "This will erase all fields saved on this device.",
  "R√©initialiser tout": "Reset all",
  "R√©initialis√© ‚úÖ": "Reset ‚úÖ",
  "Copi√© ‚úÖ": "Copied ‚úÖ",

  "Choisir": "Choose",
  "Choisir un site": "Choose a site",

  // Confirm text
  "R√©initialiser tous les champs?": "Reset all fields?",
  "Cette action efface toutes les valeurs sauvegard√©es sur cet appareil.": "This will clear all saved values on this device.",
  "Annuler": "Cancel",
  "OK": "OK",
  "R√©glages du transmetteur": "Transmitter settings",
  "Valeur √† consigner:": "Value to record:",
  "Valeurs √† consigner:": "Values to record:",
  "Lecture (FFM/PIR)": "Reading (FFM/PIR)",
  "Lecture (NF/PIR)": "Reading (NF/PIR)",
  "Valeur √† consigner": "Value to record",
  "Valeurs √† consigner": "Values to record",
  "R√©sum√©": "Summary",
  "üìã Copier": "üìã Copy",
  "üóëÔ∏è Effacer tout": "üóëÔ∏è Erase all",
  "Sauvegarde locale automatique": "Automatic local save",
  "Copie bloqu√©e ‚ùå": "Copy blocked ‚ùå",
  "Date": "Date",
  "Date/heure (Z)": "Date/Time (Z)",
  "Version de l‚Äôapp": "App version",
  "‚ö†Ô∏è S√©lectionne CAT I / II / III √† l‚Äô√©tape 0/10.": "‚ö†Ô∏è Select CAT I / II / III at step 0/10.",
  "Positionner le v√©hicule au rep√®re sol du secteur 90 Hz.": "Position the vehicle at the 90 Hz course-sector ground marker.",
  "Consigner la DDM mesur√©e au PIR.": "Record the DDM measured at the PIR.",
  "Aller directement au rep√®re CL.": "Proceed directly to the CL marker.",
  "Positionner le v√©hicule au rep√®re CL.": "Position the vehicle at the CL marker.",
  "Consigner DDM, Niveau RF et SDM mesur√©s au PIR.": "Record DDM, RF level and SDM measured at the PIR.",
  "Consigner le niveau RF mesur√©e au PIR.": "Record the RF level measured at the PIR.",
  "Entrer la DDM mesur√©e au centre de piste lors de l‚Äôinspection en vol.": "Enter the DDM measured on runway centerline during the flight inspection.",
  "CL DDM lors du flight calibration (TX1 ou TX2)": "CL DDM during flight calibration (TX1 or TX2)",
  "Alarme position 90 Hz: s√©lectionner CL test signal 2.": "90 Hz position alarm: select CL test signal 2.",
  "Alarme position 150 Hz: s√©lectionner CL test signal 1.": "150 Hz position alarm: select CL test signal 1.",
  "Largeur: s√©lectionner Narrow (DS).": "Width: select Narrow (DS).",
  "Largeur : s√©lectionner Wide (DS).": "Width: select Wide (DS).",
  "Flight Check F4: cocher Test RF attenuation pour COU (directif) et CLR (marge).": "Flight Check F4: check Test RF attenuation for COU (course) and CLR (clearance).",
  "Monitor Measurements F5: confirmer DDM CL du moniteur en alarme persistante (A) et √† < 0,8 ¬µA de la limite; ajuster le signal d‚Äôessai CL au besoin.": "Monitor Measurements F5: confirm monitor CL DDM is in persistent alarm (A) and within < 0.8 ¬µA of the limit; adjust the CL test signal as needed.",
  "Monitor Measurements F5: confirmer DDM DS du moniteur en alarme persistante (A) et √† < 0,8 ¬µA de la limite basse; ajuster le signal d‚Äôessai DS au besoin.": "Monitor Measurements F5: confirm monitor DS DDM is in persistent alarm (A) and within < 0.8 ¬µA of the low limit; adjust the DS test signal as needed.",
  "Monitor Measurements F5: confirmer DDM DS du moniteur en alarme persistante (A) et √† < 0,8 ¬µA de la limite haute; ajuster le signal d‚Äôessai DS au besoin.": "Monitor Measurements F5: confirm monitor DS DDM is in persistent alarm (A) and within < 0.8 ¬µA of the high limit; adjust the DS test signal as needed.",
  "Monitor Measurements F5: confirmer CL RF Level et CLR RF Level tout juste en alarme basse persistante; ajuster Test RF attenuation au besoin.": "Monitor Measurements F5: confirm CL RF Level and CLR RF Level are just into persistent low alarm; adjust Test RF attenuation as needed.",
  "Monitor Measurements F5: confirmer CL RF Level et CLR RF Level tout juste en alarme haute persistante; ajuster Test RF attenuation au besoin.": "Monitor Measurements F5: confirm CL RF Level and CLR RF Level are just into persistent high alarm; adjust Test RF attenuation as needed.",
  "Positionner le v√©hicule au rep√®re sol du quart de directif 150 Hz.": "Position the vehicle at the 150 Hz quarter-course ground marker.",
  "Importer les lectures normales prises plus t√¥t (90 Hz, CL, 150 Hz).": "Import the normal readings taken earlier (90 Hz, CL, 150 Hz).",
  "Calculer ŒîCL, puis 90 Hz corrig√© et 150 Hz corrig√©.": "Compute ŒîCL, then corrected 90 Hz and corrected 150 Hz.",
  "TX principal: TX1 (ou TX2) ‚Äî Alarm limit check.": "Main TX: TX1 (or TX2) ‚Äî Alarm limit check.",
  "But: lecture PIR ‚âà lecture DDM Axe du moniteur (F5) mais en d√©tection inverse.": "Goal: PIR reading ‚âà monitor course DDM (F5), but with inverse detection.",
  "But: lecture PIR correspond √† DDM FSC du moniteur (F5), mais en d√©tection inverse (signal pr√©dominant 90 Hz).": "Goal: PIR reading corresponds to monitor FSC DDM (F5), but with inverse detection (90 Hz dominant signal).",
  "Confirmer que la lecture PIR est √† ¬±5 ¬µA (le plus loin possible du moniteur/antenne de champ proche).": "Confirm the PIR reading is within ¬±5 ¬µA (as far as possible from the monitor/near-field antenna).",
  "Positionner le tr√©pied au PIR (axe / alignement).": "Place the tripod at the PIR (course / alignment).",
  "Lire et consigner la DDM et le niveau RF mesur√©s au PIR.": "Read and record the DDM and RF level measured at the PIR.",
  "Lire et consigner le niveau RF mesur√© au PIR.": "Read and record the RF level measured at the PIR.",
  "Lire et consigner la DDM mesur√©e au PIR (tr√©pied).": "Read and record the DDM measured at the PIR (tripod).",
  "Monitor Measurements F5: confirmer DDM Axe en alarme persistante (A) et √† < 0,8 ¬µA de la limite; ajuster le signal d‚Äôessai au besoin.": "Monitor Measurements F5: confirm course DDM is in persistent alarm (A) and within < 0.8 ¬µA of the limit; adjust the test signal as needed.",
  "Monitor Measurements F5: confirmer DDM FSC en alarme persistante (A) et √† < 0,8 ¬µA de la limite; ajuster au besoin.": "Monitor Measurements F5: confirm FSC DDM is in persistent alarm (A) and within < 0.8 ¬µA of the limit; adjust as needed.",
  "Monitor Measurements F5: confirmer RF CLR et RF CL tout juste en alarme basse persistante (‚âà -2,5 dB); ajuster Test RF attenuation au besoin.": "Monitor Measurements F5: confirm RF CLR and RF CL are just into persistent low alarm (‚âà -2.5 dB); adjust Test RF attenuation as needed.",
  "Monitor Measurements F5: confirmer RF CLR et RF CL tout juste en alarme haute persistante (‚âà +2,5 dB); ajuster Test RF attenuation au besoin.": "Monitor Measurements F5: confirm RF CLR and RF CL are just into persistent high alarm (‚âà +2.5 dB); adjust Test RF attenuation as needed.",
  "Alarme position 150 Hz: Flight check F4 ‚Üí CL test signal 1 (signal pr√©dominant 150 Hz).": "150 Hz position alarm: Flight Check F4 ‚Üí CL test signal 1 (150 Hz dominant signal).",
  "Alarme position 90 Hz: Flight check F4 ‚Üí CL test signal 2 (signal pr√©dominant 90 Hz).": "90 Hz position alarm: Flight Check F4 ‚Üí CL test signal 2 (90 Hz dominant signal).",
  "Flight check F4 ‚Üí Wide Alarm ‚Üí s√©lectionner Wide (DS).": "Flight Check F4 ‚Üí Wide Alarm ‚Üí select Wide (DS).",
  "Flight check F4 ‚Üí Narrow Alarm ‚Üí s√©lectionner Narrow (DS).": "Flight Check F4 ‚Üí Narrow Alarm ‚Üí select Narrow (DS).",
  "Flight check F4: cocher Test RF attenuation pour COU (directif) et CLR (marge).": "Flight Check F4: check Test RF attenuation for COU (course) and CLR (clearance).",
  "Position de largeur de secteur (voir figures).": "Sector-width position (see figures).",
  "Positionner le tr√©pied au point DS (largeur de secteur).": "Place the tripod at the DS point (sector width).",
  "Remettre Test RF attenuation √† OFF (configuration normale).": "Set Test RF attenuation back to OFF (normal configuration).",
  "Si instable: r√©duire les signaux de marge et r√©essayer.": "If unstable: reduce the clearance signals and try again.",
  "Largeur de secteur - DS normal": "Sector width - DS normal",
  "Largeur de secteur - DS wide alarm": "Sector width - DS wide alarm",
  "Largeur de secteur - DS narrow alarm": "Sector width - DS narrow alarm",
  "Directif (Alignement) - Lectures normales": "Course (Alignment) - Normal readings",

  "Axe Glide Path": "Glide Path axis",
  "Largeur de secteur ‚Äî DS": "Sector width ‚Äî DS",
  "DDM GP normal": "Normal GP DDM",
  "Position alarm 150": "Position alarm 150",
  "Position alarm 90": "Position alarm 90",
  "RF normal": "Normal RF",
  "RF low alarm": "RF low alarm",
  "RF high alarm": "RF high alarm",
  "DS normal": "DS normal",
  "DS wide alarm": "DS wide alarm",
  "DS narrow alarm": "DS narrow alarm",
  "Selon les documents:": "Per documents:",
  "4-3GP-12/4 √âd. xx & 4-3GP-12/5 √âd. xx": "4-3GP-12/4 Ed. xx & 4-3GP-12/5 Ed. xx",
  "Infos": "Info",
  "TX en service": "TX in service",
  "Cat√©gorie ILS": "ILS category",
  "Lectures de pistes (PIR)": "Runway readings (PIR)",
  "Niveau RF normal": "Normal RF level",
  "Niveau RF bas": "Low RF level",
  "Niveau RF haut": "High RF level",
  "DDM alarme 90": "DDM alarm 90",
  "DDM alarme 150": "DDM alarm 150",
  "DDM alarme large": "Wide alarm DDM",
  "DDM alarme √©troit": "Narrow alarm DDM",
  "Secteur 90 Hz": "90 Hz sector",
  "Secteur 150 Hz": "150 Hz sector",
  "Centreline (CL)": "Centreline (CL)",
  "Formules": "Formulas",
  "Notes": "Notes",
  "Selon les documents:": "Per documents:",
  "4-3LOC-12/4 √âd. 29 & 4-3LOC-12/5 √âd. 36": "4-3LOC-12/4 Ed. 29 & 4-3LOC-12/5 Ed. 36",
  "90 Hz corrig√©": "Corrected 90 Hz",
  "150 Hz corrig√©": "Corrected 150 Hz",
  "DDM 90 Hz normal": "Normal 90 Hz DDM",
  "DDM 150 Hz normal": "Normal 150 Hz DDM",
  "CL DDM normal": "Normal CL DDM",
  "ŒîCL = CL DDM - CL DDM (FC)": "ŒîCL = CL DDM now - CL DDM (FC)",
  "90Hz corrig√© = DDM 90 Hz - ŒîCL": "Corrected 90Hz = 90Hz DDM - ŒîCL",
  "150Hz corrig√© = DDM 150 Hz - ŒîCL": "Corrected 150 Hz = 150Hz DDM - ŒîCL",
  "Configuration normale: CL test off / DS test off / Test RF attenuation OFF.": "Normal configuration: CL test off / DS test off / Test RF attenuation OFF."

};

function tr(frText){
  if (lang === "fr") return frText;
  return I18N_EN[frText] || frText;
}

function applyI18n(root=document){// Elements with single text node
  const els = root.querySelectorAll("*");
  els.forEach(el=>{
    // text
    if (el.childNodes && el.childNodes.length === 1 && el.childNodes[0].nodeType === 3){
      const raw = el.textContent;
      const txt = raw.trim();
      if (!txt) return;

      // store original FR once
      if (!el.dataset.i18nFr) el.dataset.i18nFr = txt;

      const fr = el.dataset.i18nFr;
      const translated = tr(fr);

      // preserve surrounding spaces if any
      const lead = raw.match(/^\s*/)?.[0] || "";
      const tail = raw.match(/\s*$/)?.[0] || "";
      el.textContent = lead + translated + tail;
    }

    // title / aria-label
    ["title","aria-label"].forEach(attr=>{
      const v = el.getAttribute(attr);
      if (!v) return;
      const key = "i18nFr_" + attr.replace("-","_");
      if (!el.dataset[key]) el.dataset[key] = v;
      el.setAttribute(attr, tr(el.dataset[key]));
    });

    // placeholders
    if (el.tagName === "INPUT" || el.tagName === "TEXTAREA"){
      const ph = el.getAttribute("placeholder");
      if (ph){
        if (!el.dataset.i18nFrPlaceholder) el.dataset.i18nFrPlaceholder = ph;
        el.setAttribute("placeholder", tr(el.dataset.i18nFrPlaceholder));
      }
    }
  });

  // Header specific (title/sub)
  const h1 = document.querySelector(".headerCenter h1");
  if (h1){ if (!h1.dataset.i18nFr) h1.dataset.i18nFr = h1.textContent.trim(); h1.textContent = tr(h1.dataset.i18nFr); }
  const sub = document.querySelector(".headerCenter .sub");
  if (sub){ if (!sub.dataset.i18nFr) sub.dataset.i18nFr = sub.textContent.trim(); sub.textContent = tr(sub.dataset.i18nFr); }

  // Toast default
  const toast = document.getElementById("toast");
  if (toast){
    if (!toast.dataset.i18nFr) toast.dataset.i18nFr = toast.textContent.trim();
    toast.textContent = tr(toast.dataset.i18nFr);
  }
}

function setLang(next){
  lang = (next || "en").toLowerCase();
  if (lang !== "en" && lang !== "fr") lang = "en";
  localStorage.setItem(LANG_KEY, lang);
  document.documentElement.setAttribute("lang", lang);
  applyI18n(document);
  // Re-render current view so dynamic text (steps/summary/buttons) follows language immediately
  if (typeof render === "function") render();
}

function toggleLang(){
  setLang(lang === "fr" ? "en" : "fr");
}

// Use the top-left icon to toggle language (single tap)
(function(){
  const brand = document.querySelector(".brandQuad");
  if(!brand) return;
  brand.addEventListener("click", (e)=>{
    // Let the easter egg still work on multi-taps; this remains a normal click.
    toggleLang();
  });
})();


// === RESET ALL ===
function resetAll(){
    openResetModal();
  }

  function openResetModal(){
    const ov = document.getElementById("resetOverlay");
    if(!ov) return;

    // Update texts based on language
    const tTitle = document.getElementById("resetTitle");
    const tMsg   = document.getElementById("resetMsg");
    const bCancel= document.getElementById("resetCancel");
    const bOk    = document.getElementById("resetConfirm");

    if(lang === "en"){
      if(tTitle) tTitle.textContent = "Reset";
      if(tMsg)   tMsg.textContent   = "This will erase all fields saved on this device.";
      if(bCancel)bCancel.textContent= "Cancel";
      if(bOk)    bOk.textContent    = "Erase";
    } else {
      if(tTitle) tTitle.textContent = "R√©initialiser";
      if(tMsg)   tMsg.textContent   = "Cette action efface tous les champs sauvegard√©s sur cet appareil.";
      if(bCancel)bCancel.textContent= "Annuler";
      if(bOk)    bOk.textContent    = "Tout effacer";
    }

    ov.classList.add("isOpen");
    ov.setAttribute("aria-hidden","false");
  }

  function closeResetModal(){
    const ov = document.getElementById("resetOverlay");
    if(!ov) return;
    ov.classList.remove("isOpen");
    ov.setAttribute("aria-hidden","true");
  }

  function doResetAll(){
    try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
    // Also clear legacy key if present (older package)
    try{ localStorage.removeItem("GBAV_VEHICLE_CHECKS_V2"); }catch(e){}

    // Reset in-memory state (state is const)
    state.idx = 0;
    state.meta = { equip:"LOC", gbav:false, siteid:"", ti:"TI", tx:"TX1", cat:"CAT I" };
    state.values = {};

    save();
    render();
    closeResetModal();
  }

  const LEGACY_KEYS = ['GBAV_VEHICLE_CHECKS_V2','ILS_READINGS_V1_OLD'];

  // === R√©f√©rences DOM principales ===
  // (contenu rendu dans #main; barre de progression dans #bar/#barPct)

  // === D√©finition des √©tapes (donn√©es) ===
  // Chaque entr√©e d√©crit: le libell√©, l‚Äôunit√©, et les instructions affich√©es.

  // Mini-proc√©dures bas√©es sur la logique 5.5.2.2 (RMM master / F5 / Flight Check F4 / Alarm limit check TX1 / CL test / RF attenuation / Wide/Narrow / DS test off)
  const stepsLOC = [
    // 1) Secteur 90 Hz ‚Äî lecture de r√©f√©rence
    {
      type:"single",
      id:"s90_ddm_norm",
      group:"",
      label:"90 Course Sector - DDM normal",
      unit:"-¬µA",
      placeholder:"ex: -70.0",
      shelter: [],
      field: [
        "Positionner le v√©hicule au rep√®re sol du secteur 90 Hz.",
        "Consigner la DDM mesur√©e au PIR.",
        "Aller directement au rep√®re CL."
      ]
    },

    // 2) CL ‚Äî lectures normales regroup√©es (DDM + RF + SDM)
    {
      type:"multi",
      id:"cl_normals",
      group:"",
      label:"Centreline - Lectures normales",
      shelter: [
        "Configuration normale: CL test off / DS test off / Test RF attenuation OFF."
      ],
      field: [
        "Positionner le v√©hicule au rep√®re CL.",
        "Consigner DDM, Niveau RF et SDM mesur√©s au PIR."
      ],
      inputs: [
        { id:"cl_ddm_norm", label:"DDM normal", unit:"¬±¬µA", placeholder:"ex: 0.5", inputmode:"decimal" },
        { id:"cl_rf_norm",  label:"RF LVL normal", unit:"dB", placeholder:"ex: -48.0", inputmode:"decimal" },
        { id:"cl_sdm",      label:"SDM", unit:"%", placeholder:"ex: 39.99", inputmode:"decimal" }
      ]
    },

    // 3) CL ‚Äî alarmes position
    {
      type:"single",
      id:"cl_ddm_a90",
      group:"",
      label:"Centreline - Position Alarm 90",
      unit:"-¬µA",
      placeholder:"ex: -12.0",
      shelter: [
        "Alarme position 90 Hz: s√©lectionner CL test signal 2.",
        "Monitor Measurements F5: confirmer DDM CL du moniteur en alarme persistante (A) et √† < 0,8 ¬µA de la limite; ajuster le signal d‚Äôessai CL au besoin."
      ],
      field: [
        "Positionner le v√©hicule au rep√®re CL.",
        "Consigner la DDM mesur√©e au PIR."
      ]
    },

    {
      type:"single",
      id:"cl_ddm_a150",
      group:"",
      label:"Centreline - Position Alarm 150",
      unit:"+¬µA",
      placeholder:"ex: 12.0",
      shelter: [
        "Alarme position 150 Hz: s√©lectionner CL test signal 1.",
        "Monitor Measurements F5: confirmer DDM CL du moniteur en alarme persistante (A) et √† < 0,8 ¬µA de la limite; ajuster le signal d‚Äôessai CL au besoin."
      ],
      field: [
        "Positionner le v√©hicule au rep√®re CL.",
        "Consigner la DDM mesur√©e au PIR."
      ]
    },

    // 4) CL ‚Äî alarmes RF (low/high)
    {
      type:"single",
      id:"cl_rf_low",
      group:"",
      label:"Centreline - Low RF alarm ",
      unit:"dB",
      placeholder:"ex: -49.0",
      shelter: [
        "Flight Check F4: cocher Test RF attenuation pour COU (directif) et CLR (marge).",
        "Monitor Measurements F5: confirmer CL RF Level et CLR RF Level tout juste en alarme basse persistante; ajuster Test RF attenuation au besoin."
      ],
      field: [
        "Positionner le v√©hicule au rep√®re CL.",
        "Consigner le niveau RF mesur√©e au PIR."
      ]
    },

    {
      type:"single",
      id:"cl_rf_high",
      group:"",
      label:"Centreline - High RF alarm",
      unit:"dB",
      placeholder:"ex: -45.0",
      shelter: [
        "Flight Check F4: Test RF attenuation (COU et CLR).",
        "Monitor Measurements F5: confirmer CL RF Level et CLR RF Level tout juste en alarme haute persistante; ajuster Test RF attenuation au besoin."
      ],
      field: [
        "Positionner le v√©hicule au rep√®re CL.",
        "Consigner le niveau RF mesur√©e au PIR."
      ]
    },

    // 5) Secteur 150 Hz ‚Äî lectures et alarmes DS
    {
      type:"single",
      id:"s150_ddm_norm",
      group:"",
      label:"150 Course Sector - DDM normal",
      unit:"+¬µA",
      placeholder:"ex: 65.0",
      defaultValue:"65.0",
      field: [
        "Positionner le v√©hicule au rep√®re sol du quart de directif 150 Hz.",
        "Consigner la DDM mesur√©e au PIR."
      ]
    },

    {
      type:"single",
      id:"s150_ddm_wide",
      group:"",
      label:"150 Course Sector - DS wide alarm",
      unit:"+¬µA",
      placeholder:"ex: 75.0",
      shelter: [
        "Flight Check F4 ‚Üí Alarm limit check ‚Üí TX1.",
        "Largeur : s√©lectionner Wide (DS).",
        "Monitor Measurements F5: confirmer DDM DS du moniteur en alarme persistante (A) et √† < 0,8 ¬µA de la limite basse; ajuster le signal d‚Äôessai DS au besoin."
      ],
      field: [
        "Positionner le v√©hicule au rep√®re sol du quart de directif 150 Hz.",
        "Consigner la DDM mesur√©e au PIR."
      ]
    },

    {
      type:"single",
      id:"s150_ddm_narrow",
      group:"",
      label:"150 Course Sector - DS narrow alarm",
      unit:"+¬µA",
      placeholder:"ex: 60.0",
      shelter: [
        "Flight Check F4 ‚Üí Alarm limit check ‚Üí TX1.",
        "Largeur: s√©lectionner Narrow (DS).",
        "Monitor Measurements F5: confirmer DDM DS du moniteur en alarme persistante (A) et √† < 0,8 ¬µA de la limite haute; ajuster le signal d‚Äôessai DS au besoin."
      ],
      field: [
        "Positionner le v√©hicule au rep√®re sol du quart de directif 150 Hz.",
        "Consigner la DDM mesur√©e au PIR."
      ]
    },

    // 6) Lecture (FFM/PIR) ‚Äî correction (selon inspection en vol)
    {
      type:"calc",
      id:"track_corr",
      group:"",
      label:"CL DDM lors du flight calibration (TX1 ou TX2)",
      unit:"¬±¬µA",
      placeholder:"ex: 0.2",
      shelter: [],
      field: [
        "Importer les lectures normales prises plus t√¥t (90 Hz, CL, 150 Hz).",
        "Entrer la DDM mesur√©e au centre de piste lors de l‚Äôinspection en vol.",
        "Calculer ŒîCL, puis 90 Hz corrig√© et 150 Hz corrig√©."
      ],
      flightInput: { id:"cl_ddm_flight", label:"CL DDM (flight cal)", unit:"¬±¬µA", placeholder:"ex: - 1.2", inputmode:"decimal" },
      flightInputs: [
        { id:"w90_ddm_flight", label:"90Hz Width DDM (flight cal)", unit:"-¬µA", placeholder:"ex: -70.0", inputmode:"decimal" },
        { id:"w150_ddm_flight", label:"150Hz Width DDM (flight cal)", unit:"+¬µA", placeholder:"ex: 70.0", inputmode:"decimal" }
      ]}
  ];
  // =========================================================
  // Glide Path ‚Äî GBAV (proc√©dure 5.5.2)
  // =========================================================
  const stepsGP = [
    // 1) Directif ‚Äî Alignement (lectures normales)
    {
      type:"multi",
      id:"gp_dir_normals",
      group:"",
      label:"Directif (Alignement) - Lectures normales",
      shelter:[
        "Configuration normale.",
        "Brancher le PIR dans le c√¢ble NF."
      ],
      field:[
        "Lire et consigner la DDM et le niveau RF mesur√©s au PIR."
      ],
      inputs:[
        { id:"gp_dir_ddm_norm", label:"DDM (PIR) normal", unit:"¬µA", placeholder:"ex: -1.2", inputmode:"decimal" },
        { id:"gp_dir_rf_norm",  label:"RF LVL (PIR) normal", unit:"dB", placeholder:"ex: -59.0", inputmode:"decimal" }
      ]
    },

    // 2) Directif ‚Äî alarme position 150 Hz
    {
      type:"single",
      id:"gp_dir_ddm_a150",
      group:"",
      label:"Directif - Position Alarm 150",
      unit:"¬µA",
      placeholder:"ex: 70.0",
      shelter:[
        "Alarme position 150 Hz: Flight check F4 ‚Üí CL test signal 1.",
        "Monitor Measurements F5: confirmer DDM Axe en alarme persistante (A) et √† < 0,8 ¬µA de la limite; ajuster le signal d‚Äôessai au besoin."
      ],
      field:[
        "Lire et consigner la DDM mesur√©e au PIR."
      ]
    },

    // 3) Directif ‚Äî alarme position 90 Hz
    {
      type:"single",
      id:"gp_dir_ddm_a90",
      group:"",
      label:"Directif - Position Alarm 90",
      unit:"¬µA",
      placeholder:"ex: -70.0",
      shelter:[
        "Alarme position 90 Hz: Flight check F4 ‚Üí CL test signal 2.",
        "Monitor Measurements F5: confirmer DDM Axe en alarme persistante (A) et √† < 0,8 ¬µA de la limite; ajuster le signal d‚Äôessai au besoin."
      ],
      field:[
        "Lire et consigner la DDM mesur√©e au PIR."
      ]
    },

    // 4) Directif ‚Äî alarme RF basse
    {
      type:"single",
      id:"gp_dir_rf_low",
      group:"",
      label:"Directif - Low RF alarm",
      unit:"dB",
      placeholder:"ex: -69.0",
      shelter:[
        "Flight check F4: cocher Test RF attenuation (COU et CLR).",
        "Monitor Measurements F5: confirmer RF CLR et RF CL tout juste en alarme basse persistante (‚âà -2,5 dB); ajuster Test RF attenuation au besoin."
      ],
      field:[
        "Lire et consigner le niveau RF mesur√© au PIR."
      ]
    },

    // 5) Directif ‚Äî alarme RF haute
    {
      type:"single",
      id:"gp_dir_rf_high",
      group:"",
      label:"Directif - High RF alarm",
      unit:"dB",
      placeholder:"ex: -49.0",
      shelter:[
        "Flight check F4: Test RF attenuation (COU et CLR).",
        "Monitor Measurements F5: confirmer RF CLR et RF CL tout juste en alarme haute persistante (‚âà +2,5 dB); ajuster Test RF attenuation au besoin.",
        "Remettre Test RF attenuation √† OFF (configuration normale)."
      ],
      field:[
        "Lire et consigner le niveau RF mesur√© au PIR."
      ]
    },

    // 6) Largeur de secteur ‚Äî normal
    {
      type:"single",
      id:"gp_ds_norm",
      group:"",
      label:"Largeur de secteur - DS normal",
      unit:"¬µA",
      placeholder:"ex: -76.2",
      shelter:[
        "But: lecture PIR correspond √† DDM FSC du moniteur (F5), mais en d√©tection inverse (pr√©dominant 90 Hz).",
        "Si instable: r√©duire les signaux de marge et r√©essayer."
      ],
      field:[
        "Positionner le tr√©pied au point DS (largeur de secteur).",
        "Lire et consigner la DDM mesur√©e au PIR."
      ]
    },

    // 7) Largeur de secteur ‚Äî alarme large
    {
      type:"single",
      id:"gp_ds_wide",
      group:"",
      label:"Largeur de secteur - DS wide alarm",
      unit:"¬µA",
      placeholder:"ex: -78.0",
      shelter:[
        "Flight check F4 ‚Üí Wide Alarm ‚Üí s√©lectionner Wide (DS).",
        "Monitor Measurements F5: confirmer DDM FSC en alarme persistante (A) et √† < 0,8 ¬µA de la limite; ajuster au besoin."
      ],
      field:[
        "Positionner le tr√©pied au point DS (largeur de secteur).",
        "Lire et consigner la DDM mesur√©e au PIR."
      ]
    },

    // 8) Largeur de secteur ‚Äî alarme √©troite
    {
      type:"single",
      id:"gp_ds_narrow",
      group:"",
      label:"Largeur de secteur - DS narrow alarm",
      unit:"¬µA",
      placeholder:"ex: -74.0",
      shelter:[
        "Flight check F4 ‚Üí Narrow Alarm ‚Üí s√©lectionner Narrow (DS).",
        "Monitor Measurements F5: confirmer DDM FSC en alarme persistante (A) et √† < 0,8 ¬µA de la limite; ajuster au besoin.",
        "DS test off (configuration normale)."
      ],
      field:[
        "Positionner le tr√©pied au point DS (largeur de secteur).",
        "Lire et consigner la DDM mesur√©e au PIR."
      ]
    }
  ];

  const state = {
    idx: 0, // 0 = intro
    meta: { equip:"LOC", gbav:false, siteid:"", ti:"TI", tx:"TX1", cat:"CAT I" },
    values: {}
  };

  const $ = (id) => document.getElementById(id);

  // === Utilitaire de conversion nombre (utilis√© partout) ===
  function toNum(x) {
    const t = String(x ?? "").trim().replace(",", ".");
    if (!t) return null;
    const n = Number(t);
    return Number.isFinite(n) ? n : null;
  }

  function fmt(n) {
    return (n === null ? "‚Äî" : (Math.round(n*1000)/1000).toString());
  }

  // --- Viewport inset helper (√©vite que l'en-t√™te passe sous la barre de statut) ---
  (function(){
    const apply = () => {
      const vv = window.visualViewport;
      const top = (vv && typeof vv.offsetTop === "number") ? vv.offsetTop : 0;
      const px = Math.max(0, Math.round(top));
      document.documentElement.style.setProperty("--vvTop", px + "px");
    };
    apply();
    window.addEventListener("resize", apply, { passive:true });
    if (window.visualViewport){
      window.visualViewport.addEventListener("resize", apply, { passive:true });
      window.visualViewport.addEventListener("scroll", apply, { passive:true });
    }
  })();


  // --- Header height helper (reserve space when header is fixed) ---
  (function(){
    const headerEl = document.querySelector("header");
    if(!headerEl) return;

    const apply = () => {
      // Measure after CSS/viewport inset updates
      const h = Math.ceil(headerEl.getBoundingClientRect().height || 0);
      document.documentElement.style.setProperty("--headerH", h + "px");
    };

    // First paint + after layout settles
    requestAnimationFrame(apply);
    setTimeout(apply, 50);

    window.addEventListener("resize", apply, { passive:true });
    if (window.visualViewport){
      window.visualViewport.addEventListener("resize", apply, { passive:true });
      window.visualViewport.addEventListener("scroll", apply, { passive:true });
    }
  })();


  const main = $("main");

  // === √âquipement (LOC/GP) ===
  state.meta.equip = (state.meta.equip === "GP") ? "GP" : "LOC";

  const bar = $("bar");
  // === Wiring (√©v√©nements) ===
  // - Boutons pr√©c√©dent/suivant
  // - Emp√™che l‚Äôauto-focus (clavier mobile)
  // - Active swipe

  const btnPrev = $("btnPrev");
  const btnHome = $("btnHome");
  const btnNext = $("btnNext");
  const toast = $("toast");

  function updateNavButtons(pg){
    // applyI18n() re-writes static labels; this function is the single source of truth for dynamic nav labels
    const atLast = (state.idx === pg.length - 1);
    const nextIsSummary = (!atLast && pg[state.idx + 1] === "SUMMARY");
    const lblSummary = (lang === "en") ? "View summary" : "Voir r√©sum√©";
    const lblNext = (lang === "en") ? "Next ‚ñ∂" : "Suivant ‚ñ∂";
    btnNext.textContent = atLast ? "-" : (nextIsSummary ? lblSummary : lblNext);
    btnNext.disabled = atLast;
  }


  // === R√©f√©rences (Long press sur Home) ===
  const refOverlay = document.getElementById("refOverlay");
  const refClose = document.getElementById("refClose");
  let homePressTimer = null;
  let homeLongFired = false;

  function openRefs(){
    if(!refOverlay) return;
    refOverlay.classList.add("isOpen");
    refOverlay.setAttribute("aria-hidden","false");
    document.body.classList.add("modalOpen");
  }

  function closeRefs(){
    if(!refOverlay) return;
    refOverlay.classList.remove("isOpen");
    refOverlay.setAttribute("aria-hidden","true");
    document.body.classList.remove("modalOpen");
  }
  // ==========================
  // Site/ID picker (Home "Choisir")
  // ==========================
  const siteOverlay = document.getElementById("siteOverlay");
  const siteClose = document.getElementById("siteClose");
  const sitePickList = document.getElementById("sitePickList");

  const SITE_CHOICES = [
    "Alma/ITF13",
    "Baie-Comeau/IBC10",
    "Gasp√©/IGP10",
    "√éle-de-la-Madelaine/IGR16",
    "Mont-Joli/IYY06",
    "Qu√©bec/IQB06",
    "Sept-√éles/IZV09",
    "St-Augustin/IIF19",
    "Autre/IXX"
  ];

  function openSitePicker(){
    if(!siteOverlay) return;
    buildSitePickList();
    siteOverlay.classList.add("isOpen");
    siteOverlay.setAttribute("aria-hidden","false");
    document.body.classList.add("modalOpen");
  }

  function closeSitePicker(){
    if(!siteOverlay) return;
    siteOverlay.classList.remove("isOpen");
    siteOverlay.setAttribute("aria-hidden","true");
    document.body.classList.remove("modalOpen");
  }

  function setSiteId(v){
    state.meta.siteid = String(v || "").trim();
    save();
    render();
  }

  function buildSitePickList(){
    if(!sitePickList) return;
    const cur = String(state.meta.siteid || "").trim();
    sitePickList.innerHTML = SITE_CHOICES.map(s => {
      const isA = (s === cur) ? " isActive" : "";
      const parts = s.split("/");
      const name = parts[0] || s;
      const code = parts[1] ? ("/" + parts[1]) : "";
      return `<button type="button" class="sitePickItem${isA}" data-site="${esc(s)}">
        ${esc(name)}<span class="muted">${esc(code)}</span>
      </button>`;
    }).join("");
    sitePickList.querySelectorAll("button[data-site]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const v = b.getAttribute("data-site") || "";
        setSiteId(v);
        closeSitePicker();
      });
    });
  }

  if(siteClose){
    siteClose.addEventListener("click", closeSitePicker);
  }
  if(siteOverlay){
    siteOverlay.addEventListener("click", (e)=>{
      if(e.target === siteOverlay) closeSitePicker();
    });
  }


  if(refOverlay){
    refOverlay.addEventListener("click", (e)=>{ if(e.target === refOverlay) closeRefs(); });
    // Emp√™che les gestes (scroll/swipe) de se propager √† la page derri√®re (Android)
    refOverlay.addEventListener("touchmove", (e)=>{
      if(refOverlay.classList.contains("isOpen") && !e.target.closest(".refText")){
        e.preventDefault();
      }
      e.stopPropagation();
    }, {passive:false});
    refOverlay.addEventListener("touchstart", (e)=>{ e.stopPropagation(); }, {passive:true});

    window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeRefs(); });
  }
  if(refClose) refClose.addEventListener("click", (e)=>{ e.stopPropagation(); closeRefs(); });

  // Long press: ~650ms (assez long pour √©viter un tap normal)
  function armHomePress(){
    if (homePressTimer !== null) {
      clearTimeout(homePressTimer);
    }
    homeLongFired = false;
    homePressTimer = setTimeout(()=>{
      homeLongFired = true;
      homePressTimer = null;
      openRefs();
      // haptic (si dispo)
      try{ if(navigator.vibrate) navigator.vibrate(20); }catch(e){}
    }, 650);
  }
  function disarmHomePress(){
    if (homePressTimer !== null) {
      clearTimeout(homePressTimer);
      homePressTimer = null;
    }
  }

  // Pointer events (mobile/desktop)
  if(btnHome){
    btnHome.addEventListener("pointerdown", (e)=>{
      // Emp√™che le long press de d√©clencher le menu contextuel sur certains navigateurs
      try{ btnHome.setPointerCapture(e.pointerId); }catch(_){}
      armHomePress();
    });
    btnHome.addEventListener("pointerup", ()=> disarmHomePress());
    btnHome.addEventListener("pointercancel", ()=> disarmHomePress());
    btnHome.addEventListener("pointerleave", ()=> disarmHomePress());
  }

  function esc(s){return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  function load() {
    try {
      // Lire la nouvelle cl√©; sinon migrer depuis une cl√© legacy
      let raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        for (const k of (LEGACY_KEYS || [])) {
          const legacy = localStorage.getItem(k);
          if (legacy) {
            raw = legacy;
            try { localStorage.setItem(STORAGE_KEY, legacy); } catch(e) {}
            break;
          }
        }
      }
      if (!raw) return;

      const obj = JSON.parse(raw);
      if (!obj || typeof obj !== "object") return;

      // Ne jamais restaurer l‚Äôonglet: toujours d√©marrer √† √âtape 0
      state.idx = 0;

      // Meta
      state.meta = { ...state.meta, ...(obj.meta || {}) };

      // Compat: gbavOn -> gbav (anciennes sauvegardes)
      if (typeof state.meta.gbav !== "boolean" && typeof state.meta.gbavOn !== "undefined") {
        state.meta.gbav = !!state.meta.gbavOn;
      }
      if (typeof state.meta.gbav !== "boolean") state.meta.gbav = false;

      // Migration: anciennes sauvegardes (site + runway) -> siteid
      if (!state.meta.siteid) {
        const oldRun = String(state.meta.runway || "").trim();
        const oldSite = String(state.meta.site || "").trim();
        const code = (oldRun.match(/^[A-Za-z]{3}/) || [""])[0].toUpperCase();
        if (code === "IQB") state.meta.siteid = "Qu√©bec/IQB06";
        else if (code === "IZV") state.meta.siteid = "Sept-√éles/IZV09";
        else if (code === "ITF") state.meta.siteid = "Alma/ITF13";
        else if (code === "IBC") state.meta.siteid = "Baie-Comeau/IBC10";
        else if (code === "IGR") state.meta.siteid = "√éle-de-la-Madelaine/IGR16";
        else if (code === "IGP") state.meta.siteid = "Gasp√©/IGP10";
        else if (code === "IYY") state.meta.siteid = "Mont-Joli/IYY06";
        else if (code === "IIF") state.meta.siteid = "St-Augustin/IIF19";
        else if (oldRun || oldSite) state.meta.siteid = "Autre/IXX";
      }
      // Nettoyage (√©vite d'afficher/propager les vieux champs)
      if (typeof state.meta.site !== "undefined") delete state.meta.site;
      if (typeof state.meta.runway !== "undefined") delete state.meta.runway;


      // Upgrade: anciennes valeurs de siteid (sans suffixe) -> nouvelles valeurs (avec suffixe)
      {
        const sid = String(state.meta.siteid || "");
        if (sid === "Qu√©bec/IQB") state.meta.siteid = "Qu√©bec/IQB06";
        else if (sid === "Sept-√éles/IZV") state.meta.siteid = "Sept-√éles/IZV09";
        else if (sid === "Alma/ITF") state.meta.siteid = "Alma/ITF13";
        else if (sid === "Baie-Comeau/IBC") state.meta.siteid = "Baie-Comeau/IBC10";
        else if (sid === "Gasp√©/IGP") state.meta.siteid = "Gasp√©/IGP10";
        else if (sid === "Mont-Joli/IYY") state.meta.siteid = "Mont-Joli/IYY06";
        else if (sid === "St-Augustin/IIF") state.meta.siteid = "St-Augustin/IIF19";
        else if (sid === "√éles-de-la-Madelaine/IGR" || sid === "Iles-de-la-Madelaine/IGR") state.meta.siteid = "√éle-de-la-Madelaine/IGR16";
      }
      // Nettoyage
      if (typeof state.meta.site !== "undefined") delete state.meta.site;
      if (typeof state.meta.runway !== "undefined") delete state.meta.runway;
// Defaults / sanity (√©vite qu'une vieille sauvegarde vide √©crase les valeurs par d√©faut)
      if (!state.meta.ti || !String(state.meta.ti).trim()) state.meta.ti = "TI";
      const txv = String(state.meta.tx || "").trim().toUpperCase();
      state.meta.tx = (txv === "TX2") ? "TX2" : "TX1";
      // CAT (ILS): CAT I / CAT II / CAT III (optionnel en lecture de piste)
      const catv = String(state.meta.cat || "").trim().toUpperCase().replace(/\s+/g," ");
      if (catv === "CAT I" || catv === "CAT II" || catv === "CAT III") state.meta.cat = catv;
      else state.meta.cat = "CAT I";
      // TI: si une ancienne sauvegarde contient ti vide, on remet la valeur par defaut
      if (!state.meta.ti || String(state.meta.ti).trim() === "") state.meta.ti = "TI";
      state.values = { ...(obj.values || {}) };
    } catch (e) {
      console.error("Erreur lors du chargement des donn√©es:", e);
      // On continue avec les valeurs par d√©faut
    }
  }

  // === Auto-save (localStorage) ===
  // On sauvegarde les VALEURS, mais on NE RESTAURE PAS l‚Äôonglet (toujours 0/10 au d√©marrage).

  function save() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        // idx n'est pas sauvegard√© car on d√©marre toujours √† 0
        meta: state.meta,
        values: state.values
      }));
    } catch (e) {
      console.error("Erreur lors de la sauvegarde:", e);
    }
  }

  function isFilled(v) {
    return v !== undefined && v !== null && String(v).trim() !== "";
  }

  function itemIdsForStep(s){
    if (s.type === "multi") return (s.inputs || []).map(x => x.id);
    if (s.type === "calc") return [s.flightInput?.id, ...(s.flightInputs||[]).map(x=>x.id)].filter(Boolean);
    return [s.id];
  }

    function getSteps(){
    return (state.meta.equip === "GP") ? stepsGP : stepsLOC;
  }

function activeStepIdxs(){
    // Steps are 0-based in `steps` (0..9 => √âtape 1/10..10/10)
    // Default (Lecture (FFM/PIR)): 1,2,7,10 => indices 0,1,6,9
    const steps = getSteps();
    if(state.meta.equip === "GP") return steps.map((_,i)=>i);
    return state.meta.gbav ? steps.map((_,i)=>i) : [0,1,6,9];
  }

  function allItemIds(){
    const steps = getSteps();
    return activeStepIdxs().flatMap(i => itemIdsForStep(steps[i]));
  }

  function progressPct() {
    const ids = allItemIds();
    const total = ids.length || 1;
    const done = ids.filter(id => isFilled(state.values[id])).length;
    return Math.round((done / total) * 100);
  }

  function setBar() {
    const p = progressPct();
    if (bar) {
      bar.style.width = p + "%";
    }
    const bp = document.getElementById("barPct");
    if (bp) bp.textContent = p + "%";
  }

  function showToast(msg="Copi√© ‚úÖ") {
    if (!toast) {
      console.warn("Toast element not found");
      return;
    }
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toast.classList.remove("show"), 1400);
  }

  function renderIntro() {
  const gbavOn = !!state.meta.gbav;
  const cat = String(state.meta.cat || "").trim().toUpperCase().replace(/\s+/g," ");
  const tx  = String(state.meta.tx || "").trim().toUpperCase() === "TX2" ? "TX2" : "TX1";

  main.innerHTML = `

    <div class="homeStack">
      <div class="equipRow">
        <div class="equipGroup" role="group" aria-label="√âquipement (LOC/GP)">
          <button type="button" class="equipBtn ${state.meta.equip==="LOC" ? "isOn" : ""}" data-equip="LOC">LOC</button>
          <button type="button" class="equipBtn ${state.meta.equip==="GP" ? "isOn" : ""}" data-equip="GP">GP</button>
        </div>
      </div>

      <div class="catRow">
        <div class="catGroup" role="group" aria-label="">
          <button type="button" class="catBtn ${cat==="CAT I" ? "isOn" : ""}" data-cat="CAT I">CAT I</button>
          <button type="button" class="catBtn ${cat==="CAT II" ? "isOn" : ""}" data-cat="CAT II">CAT II</button>
          <button type="button" class="catBtn ${cat==="CAT III" ? "isOn" : ""}" data-cat="CAT III">CAT III</button>
        </div>
      </div>

      <div class="txRow">
        <div class="txChoice" role="group" aria-label="">
          <button type="button" class="txBtn ${tx==="TX1" ? "isOn" : ""}" data-tx="TX1">TX1</button>
          <button type="button" class="txBtn ${tx==="TX2" ? "isOn" : ""}" data-tx="TX2">TX2</button>
        </div>
      </div>

      <div class="txRow">
        <div id="gbavToggle" class="gbavToggle ${gbavOn ? "isOn" : ""}" role="button" tabindex="0" aria-pressed="${gbavOn ? "true" : "false"}">
          GBAV
        </div>
      </div>

      <div class="txRow">
        <button id="btnResetHome" class="navBtn secondary resetBtnHome" type="button">R√©initialiser</button>
      </div>
    </div>

    <div class="infoHdr" aria-hidden="true"></div>

    <div class="metaStack">
      <div style="width:100%; max-width:520px;">
        <label style="display:block; text-align:center; margin-bottom:6px; color: rgba(231,234,242,.70);" data-i18n="Site/ID">Site/ID</label>
        <div class="siteRow" style="width:100%; max-width:520px; margin: 0 auto;">
          <input id="meta_siteid_text" type="text" value="${esc(state.meta.siteid)}" placeholder="‚Äî" autocomplete="off" />
          <button id="sitePickBtn" class="equipBtn chooseBtn" type="button" data-i18n="Choisir">Choisir</button>
        </div>
      </div>

      <div style="width:100%; max-width:520px;">
        <label style="display:block; text-align:center; margin-bottom:6px; color: rgba(231,234,242,.70);">TI</label>
        <input id="meta_ti" placeholder="ex: TI123456" value="${esc(state.meta.ti)}">
      </div>
</div>
  `;

  const toggle = document.getElementById("gbavToggle");
  const onToggle = () => {
    state.meta.gbav = !state.meta.gbav;
    // En changeant de mode, on garde l'utilisateur √† l'√©tape 0/10 pour √©viter des incoh√©rences.
    state.idx = 0;
    save();
    render();
  };
  toggle.addEventListener("click", onToggle);
  toggle.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") { e.preventDefault(); onToggle(); }
  });

  const bind = (id, key) => {
    const el = $(id);
    el.addEventListener("input", () => {
      state.meta[key] = el.value;
      save(); setBar();
    });
    el.addEventListener("change", () => {
      state.meta[key] = el.value;
      save(); setBar();
    });
  };
  // Site/ID (menu d√©roulant)
  const bindChange = (id, key) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("change", () => {
      state.meta[key] = el.value;
      save(); setBar();
    });
  };

  // Site/ID (input libre + bouton "Choisir")
  {
    const siteInput = document.getElementById("meta_siteid_text");
    if (siteInput){
      siteInput.addEventListener("input", () => {
        state.meta.siteid = siteInput.value.trim();
        save(); setBar();
      });
      siteInput.addEventListener("change", () => {
        state.meta.siteid = siteInput.value.trim();
        save(); setBar();
      });
    }
    const pickBtn = document.getElementById("sitePickBtn");
    if (pickBtn){
      pickBtn.addEventListener("click", openSitePicker);
    }
  }


  bind("meta_ti", "ti");
// √âquipement (LOC / GP)
  document.querySelectorAll(".equipRow .equipBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const v = String(btn.getAttribute("data-equip") || "LOC").toUpperCase();
      const next = (v === "GP") ? "GP" : "LOC";
      if(state.meta.equip === next) return;
      state.meta.equip = next;
      if(next === "GP") state.meta.gbav = true;
       else state.meta.gbav = false;
      state.idx = 0;
      save(); render();
    });
  });

  // TX en service (boutons)
  document.querySelectorAll(".txBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const v = btn.getAttribute("data-tx") || "TX1";
      state.meta.tx = (String(v).toUpperCase() === "TX2") ? "TX2" : "TX1";
      save(); render();
    });
  });

  // Cat√©gorie ILS (CAT I / CAT II / CAT III)
  document.querySelectorAll(".catBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const v = (btn.getAttribute("data-cat") || "").toUpperCase().replace(/\s+/g," ");
      state.meta.cat = v; // choix obligatoire (pas de toggle off)
      save(); render();
    });
  });

  // Reset button (home)
  const rst = document.getElementById("btnResetHome");
  if(rst) rst.addEventListener("click", resetAll);

  // Apply language on new DOM
  try{ applyI18n(document); }catch(e){}
}

  // Normalise une valeur d'entr√©e: remplace virgule par point, garde string pour faciliter l'affichage
  function normalizeNumber(str) {
    // Tol√©rant pendant la saisie: on garde la string "raw" tant qu'elle ressemble √† un nombre en cours
    const t = String(str ?? "").trim().replace(",", ".");
    if (t === "") return "";

    // Autorise des √©tats interm√©diaires: "-", "+", ".", "-.", "0.", etc.
    const looksNumeric = /^[-+]?\d*(?:\.\d*)?$/.test(t);
    if (!looksNumeric) return "";

    // Si c'est un nombre complet, ok. Si c'est interm√©diaire, on le garde tel quel.
    // (La conversion en Number se fait au moment des calculs / affichage.)
    return t;
  }

  // === Normes & limites (affichage √âtape 10/10 ou 4/4) ===
  function normsSectionHtml(){
    const gbavOn = !!state.meta.gbav;
    const cat = String(state.meta.cat || "").trim().toUpperCase();
    const tolMap = {
      "CAT I":  { pos: 7, width: 5 },
      "CAT II": { pos: 5, width: 5 },
      "CAT III":{ pos: 4, width: 4 }
    };

    const badge = (ok) => ok === null ? "‚Äî" : (ok ? '<span class="ntPass">PASS</span>' : '<span class="ntFail">FAIL</span>');

    const title = gbavOn ? "" : "";

    const tol = tolMap[cat] || null;

    const v90 = toNum(state.values["s90_ddm_norm"]);
    const vCL = toNum(state.values["cl_ddm_norm"]);
    const v150 = toNum(state.values["s150_ddm_norm"]);
    const vFlight = toNum(state.values["cl_ddm_flight"]);
    const w90Flight = toNum(state.values["w90_ddm_flight"]);
    const w150Flight = toNum(state.values["w150_ddm_flight"]);

    const delta = (vCL !== null && vFlight !== null) ? (vCL - vFlight) : null;
    const c90 = (v90 !== null && delta !== null) ? (v90 - delta) : null;
    const c150 = (v150 !== null && delta !== null) ? (v150 - delta) : null;

    const okPos = (delta === null || !tol) ? null : (Math.abs(delta) <= tol.pos);
    const err90 = (c90 !== null && w90Flight !== null) ? (c90 - w90Flight) : null;
    const err150 = (c150 !== null && w150Flight !== null) ? (c150 - w150Flight) : null;

    const ok90  = (err90 === null  || !tol) ? null : (Math.abs(err90)  <= tol.width);
    const ok150 = (err150 === null || !tol) ? null : (Math.abs(err150) <= tol.width);

    const catShown = cat || "‚Äî";
    const tolPosShown = tol ? `¬±${tol.pos} ¬µA` : "‚Äî";
    const tolWShown = tol ? `¬±${tol.width} ¬µA` : "‚Äî";

    return `
      <div class="tiny" style="line-height:2.35;">
        <div style="font-weight:900; margin-bottom:6px;">${esc(title)}</div>
        <div class="catLine"><span class="catLabel">${tr("Cat√©gorie ILS :")}</span> <span class="catValue">${esc(catShown)}</span></div>

        <div class="normTable">
          <div class="ntHead">Param√®tre</div><div class="ntHead">Diff√©rence</div><div class="ntHead">Tol√©rance</div><div class="ntHead">Statut</div>

          <div class="ntRowLbl">Course Position</div>
          <div class="ntRowVal">${delta===null ? "‚Äî" : `${fmt(delta)} ¬µA`}</div>
          <div class="ntRowTol">${tolPosShown}</div>
          <div class="ntRowSt">${badge(okPos)}</div>

          <div class="ntRowLbl">90 Sector Width</div>
          <div class="ntRowVal">${err90===null ? "‚Äî" : `${fmt(err90)} ¬µA`}</div>
          <div class="ntRowTol">${tolWShown}</div>
          <div class="ntRowSt">${badge(ok90)}</div>

          <div class="ntRowLbl">150 Sector Width</div>
          <div class="ntRowVal">${err150===null ? "‚Äî" : `${fmt(err150)} ¬µA`}</div>
          <div class="ntRowTol">${tolWShown}</div>
          <div class="ntRowSt">${badge(ok150)}</div>

        </div>

        ${!cat ? `<div style="margin-top:6px; color: rgba(239,68,68,.95); font-weight:900;">‚ö†Ô∏è S√©lectionne CAT I / II / III √† l‚Äô√©tape 0/10.</div>` : ``}
      </div>
    `;
  }

  function geoForStep(i){
    // i est 0-based dans la liste d'√©tapes active (LOC ou GP)
    if(state.meta.equip === "GP"){
      // GP: Axe (PIR) puis points DS (largeur de secteur)
      if (i <= 4) return "Centreline";
      return "150 Course Sector";
    }
    // LOC (v√©hicule) : mapping historique
    if (i === 0) return "90 Course Sector";
    if (i >= 1 && i <= 5) return "Centreline";
    if (i >= 6 && i <= 8) return "150 Course Sector";
    return "Annexe A-4"; // √âtape 10/10 (Annexe A-4)
  }

  function stripGeo(label){
    let t = String(label || "").trim();
    // Retire le pr√©fixe g√©ographique si pr√©sent (ex: "Centreline - ...")
    t = t.replace(/^(90\s*Course\s*Sector|150\s*Course\s*Sector|Centreline)\s*-\s*/i, "");
    return t.trim();
  }

  function displayStepNo(stepIdx){
    // stepIdx is 0-based in current steps
    if(state.meta.equip === "GP") return stepIdx + 1;
    if (state.meta.gbav) return stepIdx + 1;
    // Lecture (FFM/PIR) (LOC): afficher 1..4 au lieu de 1,2,7,10
    const map = {0:1, 1:2, 6:3, 9:4};
    return map[stepIdx] || (stepIdx + 1);
  }
  function displayStepTotal(){
    const steps = getSteps();
    if(state.meta.equip === "GP") return steps.length;
    return state.meta.gbav ? steps.length : activeStepIdxs().length;
  }

  function renderStep(i) {
    const steps = getSteps();
    const s = steps[i];

    const fieldTitle = (state.meta.equip === "GP") ? "Lecture (NF/PIR)" : "Lecture (FFM/PIR)";

    const shelterHtml = (s.shelter && s.shelter.length)
      ? `<div class="secTitle">R√©glages du transmetteur</div>
         <div class="box"><ul class="list">${s.shelter.map(x=>`<li>${esc(x)}</li>`).join("")}</ul></div>`
      : "";

    const fieldHtml = (s.field && s.field.length)
      ? `<div class="secTitle">${fieldTitle}</div>
         <div class="box"><ul class="list">${s.field.map(x=>`<li>${esc(x)}</li>`).join("")}</ul></div>`
      : "";

    const geoPill = `<div class="pill" style="display:inline-block; margin-bottom:10px;">${esc(geoForStep(i))}</div>`;

    // --- Single ---
    if (!s.type || s.type === "single") {
      const currentVal = state.values[s.id] ?? "";
      const desc = stripGeo(s.label);

      main.innerHTML = `
        <div class="topBlock">
          <div class="stepHdr">${(lang==="en"?"Step":"√âtape")} ${displayStepNo(i)}/${displayStepTotal()}</div>
          ${geoPill}
        </div>

        <div class="secTitle">Valeur √† consigner:</div>
        <div class="consignDesc">${esc(desc)}</div>

        <div class="fieldLine">
          <input id="${esc(s.id)}" inputmode="decimal" type="text" placeholder="${esc(s.placeholder)}" value="${esc(currentVal)}" />
          <span class="unit">${esc(s.unit)}</span>
        </div>

        ${shelterHtml}
        ${fieldHtml}
      `;

      const val = $(s.id);
      val.addEventListener("input", () => {
        state.values[s.id] = normalizeNumber(val.value);
        save();
        setBar();
      });

      return;
    }

    // --- Multi ---
    if (s.type === "multi") {
      const inputsHtml = (s.inputs || []).map(inp => {
        const v = state.values[inp.id] ?? "";
        const mode = inp.inputmode || "decimal";
        const desc = stripGeo(inp.label);
        return `
          <div style="margin-top:14px;">
            <div class="consignDesc">${esc(desc)}</div>
            <div class="fieldLine">
              <input data-id="${esc(inp.id)}" inputmode="${esc(mode)}" type="text" placeholder="${esc(inp.placeholder || '')}" value="${esc(v)}" />
              <span class="unit">${esc(inp.unit)}</span>
            </div>
          </div>
        `;
      }).join("");

      main.innerHTML = `
        <div class="topBlock">
          <div class="stepHdr">${(lang==="en"?"Step":"√âtape")} ${displayStepNo(i)}/${displayStepTotal()}</div>
          ${geoPill}
        </div>

        <div class="secTitle">Valeur √† consigner:</div>
        ${inputsHtml}

        ${shelterHtml}
        ${fieldHtml}
      `;

      main.querySelectorAll('input[data-id]').forEach(el => {
        const id = el.getAttribute("data-id");
        el.addEventListener("input", () => {
          state.values[id] = normalizeNumber(el.value);
          save();
          setBar();
        });
      });

      return;
    }

    // --- Calc (Lecture (FFM/PIR) / GBAV) ---
if (s.type === "calc") {
  const flight = s.flightInput;
  const extras = (s.flightInputs || []);
  const tx = (state.meta.tx || "TX1").toUpperCase() === "TX2" ? "TX2" : "TX1";
  const txSpan = `<span class="txRed">${esc(tx)}</span>`;
  const dynDescHtml = `CL DDM ${txSpan} (flight cal)`;

  const vMain = state.values[flight.id] ?? "";
  const vW90  = state.values[extras[0]?.id] ?? "";
  const vW150 = state.values[extras[1]?.id] ?? "";

  const inputHtml = `
    <div class="consignDesc">${dynDescHtml}</div>
    <div class="fieldLine">
      <input id="flight_cl" inputmode="${esc(flight.inputmode || 'decimal')}" type="text" placeholder="${esc(flight.placeholder || '')}" value="${esc(vMain)}" />
      <span class="unit">${esc(flight.unit)}</span>
    </div>

    <div style="margin-top:14px;">
      <div class="consignDesc">90Hz Width DDM ${txSpan} (flight cal)</div>
      <div class="fieldLine">
        <input id="flight_w90" inputmode="${esc(extras[0]?.inputmode || 'decimal')}" type="text" placeholder="${esc(extras[0]?.placeholder || '')}" value="${esc(vW90)}" />
        <span class="unit">${esc(extras[0]?.unit || '¬±¬µA')}</span>
      </div>
    </div>

    <div style="margin-top:14px;">
      <div class="consignDesc">150Hz Width DDM ${txSpan} (flight cal)</div>
      <div class="fieldLine">
        <input id="flight_w150" inputmode="${esc(extras[1]?.inputmode || 'decimal')}" type="text" placeholder="${esc(extras[1]?.placeholder || '')}" value="${esc(vW150)}" />
        <span class="unit">${esc(extras[1]?.unit || '¬±¬µA')}</span>
      </div>
    </div>
  `;

  main.innerHTML = `
    <div class="topBlock">
      <div class="stepHdr">${(lang==="en"?"Step":"√âtape")} ${displayStepNo(i)}/${displayStepTotal()}</div>
      ${geoPill}
    </div>

    <div class="secTitle">Valeurs √† consigner:</div>
    ${inputHtml}

    <div class="secTitle" style="margin-top:16px;">Normes et limites</div>
    <div class="normsBox" id="normsBox">${normsSectionHtml()}</div>
  `;

  const refresh = () => {
    save();
    setBar();
    const nb = $("normsBox");
    if (nb) nb.innerHTML = normsSectionHtml();
  };

  $("flight_cl").addEventListener("input", (e) => {
    state.values[flight.id] = normalizeNumber(e.target.value);
    refresh();
  });

  $("flight_w90").addEventListener("input", (e) => {
    if (extras[0]?.id) state.values[extras[0].id] = normalizeNumber(e.target.value);
    refresh();
  });

  $("flight_w150").addEventListener("input", (e) => {
    if (extras[1]?.id) state.values[extras[1].id] = normalizeNumber(e.target.value);
    refresh();
  });

  return;
}}

  function buildSummaryText() {
    const m = state.meta;

    const zuluNow = () => {
      const d = new Date();
      const p = (n) => String(n).padStart(2, "0");
      return `${d.getUTCFullYear()}-${p(d.getUTCMonth()+1)}-${p(d.getUTCDate())} ${p(d.getUTCHours())}:${p(d.getUTCMinutes())}Z`;
    };
    const zuluStamp = zuluNow();

    const v = (id) => {
      const x = state.values[id];
      return (isFilled(x) ? x : "‚Äî");
    };

    // === R√©sum√© GP (tr√©pied) ===
    // En Glide Path, on ne pr√©sente PAS: Secteur 90/150, CL, valeurs corrig√©es, ni formules ŒîCL.
    if ((m.equip || "") === "GP") {
      const lines = [];
      lines.push("");
      lines.push(tr("Infos"));
      lines.push("-----------------------------------------");
      lines.push(`${tr("Date/heure (Z)")}: ${zuluStamp}`);
      lines.push(`${tr("Site/ID")}: ${m.siteid || ""}`);
      lines.push(`${tr("TI")}: ${m.ti || ""}`);      lines.push(`${tr("TX en service")}: ${m.tx || ""}`);
      lines.push(`${tr("Cat√©gorie ILS")}: ${m.cat || ""}`);

      lines.push("");
      lines.push(tr("Axe Glide Path"));
      lines.push("-----------------------------------------");
      lines.push(`DDM GP normal: ${isFilled(state.values["gp_dir_ddm_norm"]) ? `${v("gp_dir_ddm_norm")} ¬µA` : "‚Äî"}`);
      lines.push(`Position alarm 150: ${isFilled(state.values["gp_dir_ddm_a150"]) ? `${v("gp_dir_ddm_a150")} ¬µA` : "‚Äî"}`);
      lines.push(`Position alarm 90: ${isFilled(state.values["gp_dir_ddm_a90"]) ? `${v("gp_dir_ddm_a90")} ¬µA` : "‚Äî"}`);
      lines.push(`RF normal: ${isFilled(state.values["gp_dir_rf_norm"]) ? `${v("gp_dir_rf_norm")} dB` : "‚Äî"}`);
      lines.push(`RF low alarm: ${isFilled(state.values["gp_dir_rf_low"]) ? `${v("gp_dir_rf_low")} dB` : "‚Äî"}`);
      lines.push(`RF high alarm: ${isFilled(state.values["gp_dir_rf_high"]) ? `${v("gp_dir_rf_high")} dB` : "‚Äî"}`);

      lines.push("");
      lines.push(tr("Largeur de secteur ‚Äî DS"));
      lines.push("-----------------------------------------");
      lines.push(`DS normal: ${isFilled(state.values["gp_ds_norm"]) ? `${v("gp_ds_norm")} ¬µA` : "‚Äî"}`);
      lines.push(`DS wide alarm: ${isFilled(state.values["gp_ds_wide"]) ? `${v("gp_ds_wide")} ¬µA` : "‚Äî"}`);
      lines.push(`DS narrow alarm: ${isFilled(state.values["gp_ds_narrow"]) ? `${v("gp_ds_narrow")} ¬µA` : "‚Äî"}`);
      lines.push("");
      lines.push(tr("Notes"));
      lines.push("-----------------------------------------");
      lines.push(tr("Selon les documents:"));
      lines.push(tr("4-3GP-12/4 √âd. xx & 4-3GP-12/5 √âd. xx"));
      lines.push("");
    // footer meta added per mode

      lines.push("");
      lines.push(`${tr("Version de l‚Äôapp")}: ${APP_VERSION}`);
      lines.push("-----------------------------------------");

      return lines.join("\n");
    }

    // Calculs piste
    const v90 = toNum(state.values["s90_ddm_norm"]);
    const vCL = toNum(state.values["cl_ddm_norm"]);
    const v150 = toNum(state.values["s150_ddm_norm"]);
    const vFlight = toNum(state.values["cl_ddm_flight"]);
    const w90Flight = toNum(state.values["w90_ddm_flight"]);
    const w150Flight = toNum(state.values["w150_ddm_flight"]);
    const delta = (vCL !== null && vFlight !== null) ? (vCL - vFlight) : null;
    const c90 = (v90 !== null && delta !== null) ? (v90 - delta) : null;
    const c150 = (v150 !== null && delta !== null) ? (v150 - delta) : null;
    const err90 = (c90 !== null && w90Flight !== null) ? (c90 - w90Flight) : null;
    const err150 = (c150 !== null && w150Flight !== null) ? (c150 - w150Flight) : null;

    const lines = [];
    if (!m.gbav) {
    lines.push("");
      lines.push(tr("Infos"));
      lines.push("-----------------------------------------");
      lines.push(`${tr("Date/heure (Z)")}: ${zuluStamp}`);
      lines.push(`${tr("Site/ID")}: ${m.siteid || ""}`);
      lines.push(`${tr("TI")}: ${m.ti || ""}`);      lines.push(`${tr("TX en service")}: ${m.tx || ""}`);
    lines.push("");
      lines.push(tr("Lectures de pistes (PIR)"));
      lines.push("-----------------------------------------");
      lines.push(`${tr("90 Hz corrig√©")}: ${c90 === null ? "‚Äî" : `${fmt(c90)} ¬µA`}`);
      lines.push(`${tr("DDM 90 Hz normal")}: ${isFilled(state.values["s90_ddm_norm"]) ? `${v("s90_ddm_norm")} ¬µA` : "‚Äî"}`);
      lines.push(`${tr("CL DDM normal")}: ${isFilled(state.values["cl_ddm_norm"]) ? `${v("cl_ddm_norm")} ¬µA` : "‚Äî"}`);
      lines.push(`SDM: ${isFilled(state.values["cl_sdm"]) ? `${v("cl_sdm")} %` : "‚Äî"}`);
      lines.push(`${tr("Niveau RF normal")}: ${isFilled(state.values["cl_rf_norm"]) ? `${v("cl_rf_norm")} dB` : "‚Äî"}`);
      lines.push(`${tr("DDM 150 Hz normal")}: ${isFilled(state.values["s150_ddm_norm"]) ? `${v("s150_ddm_norm")} ¬µA` : "‚Äî"}`);
      lines.push(`${tr("150 Hz corrig√©")}: ${c150 === null ? "‚Äî" : `${fmt(c150)} ¬µA`}`);
      lines.push("");
      lines.push(tr("Formules"));
      lines.push("-----------------------------------------");
      lines.push(`${tr("ŒîCL = CL DDM - CL DDM (FC)")} = ${delta === null ? "‚Äî" : `${fmt(delta)} ¬µA`}`);
      lines.push(`${tr("90Hz corrig√© = DDM 90Hz - ŒîCL")} = ${c90 === null ? "‚Äî" : `${fmt(c90)} ¬µA`}`);
      lines.push(`${tr("150Hz corrig√© = DDM 150Hz - ŒîCL")} = ${c150 === null ? "‚Äî" : `${fmt(c150)} ¬µA`}`);
    lines.push("");
    lines.push(tr("Notes"));
      lines.push("-----------------------------------------");
      lines.push(tr("Selon les documents:"));
      lines.push(tr("4-3LOC-12/4 √âd. 29 & 4-3LOC-12/5 √âd. 36"));
    lines.push("");
      lines.push("-----------------------------------------");
      lines.push("");
      lines.push(`${tr("Version de l‚Äôapp")}: ${APP_VERSION}`);
      lines.push("-----------------------------------------");

      return lines.join("\n");
    }

    // --- Mode GBAV complet ---
  lines.push("");
  lines.push(tr("Infos"));
    lines.push("-----------------------------------------");
    lines.push(`${tr("Date/heure (Z)")}: ${zuluStamp}`);
    lines.push(`${tr("Site/ID")}: ${m.siteid || ""}`);
    lines.push(`${tr("TI")}: ${m.ti || ""}`);    lines.push(`${tr("TX en service")}: ${m.tx || ""}`);
    lines.push(`${tr("Cat√©gorie ILS")}: ${m.cat || ""}`);
  lines.push("");
  lines.push(tr("Secteur 90 Hz"));
    lines.push("-----------------------------------------");
    lines.push(`${tr("DDM 90 Hz normal")}: ${isFilled(state.values["s90_ddm_norm"]) ? `${v("s90_ddm_norm")} ¬µA` : "‚Äî"}`);
  lines.push("");
    lines.push("Centreline (CL)");
    lines.push("-----------------------------------------");
    lines.push(`${tr("CL DDM normal")}: ${isFilled(state.values["cl_ddm_norm"]) ? `${v("cl_ddm_norm")} ¬µA` : "‚Äî"}`);
    lines.push(`${tr("Niveau RF normal")}: ${isFilled(state.values["cl_rf_norm"]) ? `${v("cl_rf_norm")} dB` : "‚Äî"}`);
    lines.push(`SDM: ${isFilled(state.values["cl_sdm"]) ? `${v("cl_sdm")} %` : "‚Äî"}`);
    lines.push(`${tr("DDM alarme 90")}: ${isFilled(state.values["cl_ddm_a90"]) ? `${v("cl_ddm_a90")} ¬µA` : "‚Äî"}`);
    lines.push(`${tr("DDM alarme 150")}: ${isFilled(state.values["cl_ddm_a150"]) ? `${v("cl_ddm_a150")} ¬µA` : "‚Äî"}`);
    lines.push(`${tr("Niveau RF bas")}: ${isFilled(state.values["cl_rf_low"]) ? `${v("cl_rf_low")} dB` : "‚Äî"}`);
    lines.push(`${tr("Niveau RF haut")}: ${isFilled(state.values["cl_rf_high"]) ? `${v("cl_rf_high")} dB` : "‚Äî"}`);
  lines.push("");
  lines.push(tr("Secteur 150 Hz"));
    lines.push("-----------------------------------------");
    lines.push(`${tr("DDM 150 Hz normal")}: ${isFilled(state.values["s150_ddm_norm"]) ? `${v("s150_ddm_norm")} ¬µA` : "‚Äî"}`);
    lines.push(`${tr("DDM alarme large")}: ${isFilled(state.values["s150_ddm_wide"]) ? `${v("s150_ddm_wide")} ¬µA` : "‚Äî"}`);
    lines.push(`${tr("DDM alarme √©troit")}: ${isFilled(state.values["s150_ddm_narrow"]) ? `${v("s150_ddm_narrow")} ¬µA` : "‚Äî"}`);
  lines.push("");
    lines.push("Lectures de piste (PIR)");
    lines.push("-----------------------------------------");
    lines.push(`${tr("90 Hz corrig√©")}: ${c90 === null ? "‚Äî" : `${fmt(c90)} ¬µA`}`);
    lines.push(`${tr("DDM 90 Hz normal")}: ${isFilled(state.values["s90_ddm_norm"]) ? `${v("s90_ddm_norm")} ¬µA` : "‚Äî"}`);
    lines.push(`${tr("CL DDM normal")}: ${isFilled(state.values["cl_ddm_norm"]) ? `${v("cl_ddm_norm")} ¬µA` : "‚Äî"}`);
    lines.push(`SDM: ${isFilled(state.values["cl_sdm"]) ? `${v("cl_sdm")} %` : "‚Äî"}`);
    lines.push(`${tr("Niveau RF normal")}: ${isFilled(state.values["cl_rf_norm"]) ? `${v("cl_rf_norm")} dB` : "‚Äî"}`);
    lines.push(`${tr("DDM 150 Hz normal")}: ${isFilled(state.values["s150_ddm_norm"]) ? `${v("s150_ddm_norm")} ¬µA` : "‚Äî"}`);
    lines.push(`${tr("150 Hz corrig√©")}: ${c150 === null ? "‚Äî" : `${fmt(c150)} ¬µA`}`);
  lines.push("");
    lines.push(tr("Formules"));
    lines.push("-----------------------------------------");
    lines.push(`${tr("ŒîCL = CL DDM normal - CL DDM (FC)")} = ${delta === null ? "‚Äî" : `${fmt(delta)} ¬µA`}`);
    lines.push(`${tr("90Hz corrig√© = DDM 90Hz - ŒîCL")} = ${c90 === null ? "‚Äî" : `${fmt(c90)} ¬µA`}`);
    lines.push(`${tr("150Hz corrig√© = DDM 150Hz - ŒîCL")} = ${c150 === null ? "‚Äî" : `${fmt(c150)} ¬µA`}`);
  lines.push("");
  lines.push(tr("Notes"));
  lines.push("-----------------------------------------");
  lines.push(tr("Selon les documents:"));
  lines.push(tr("4-3LOC-12/4 √âd. 29 & 4-3LOC-12/5 √âd. 36"));
  lines.push("");
  lines.push(`${tr("Version de l‚Äôapp")}: ${APP_VERSION}`);
  lines.push("-----------------------------------------");
  return lines.join("\n");
  }

  function renderSummary() {
    const text = buildSummaryText();

    main.innerHTML = `
      <div class="summaryHeader">
        <div class="big">${tr("R√©sum√©")}</div>
        <button id="copyBtn" class="copyIconBtn" aria-label="${tr("üìã Copier")}">üìã</button>
      </div>
      <div class="mono" id="summary">${esc(text)}</div>
          `;

    $("copyBtn").addEventListener("click", async () => {
      const txt = buildSummaryText();
      try {
        await navigator.clipboard.writeText(txt);
        showToast("Copi√© ‚úÖ");
      } catch {
        const ta = document.createElement("textarea");
        ta.value = txt;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand("copy"); showToast("Copi√© ‚úÖ"); }
        catch { showToast("Copie bloqu√©e ‚ùå"); }
        finally { document.body.removeChild(ta); }
      }
    });
$("resetBtn").addEventListener("click", () => {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    });
  }

  // === Rendu UI ===
  // Construit le HTML de l‚Äô√©tape courante dans #main.

  function pages(){
    return ["INTRO", ...activeStepIdxs(), "SUMMARY"];
  }

  function render() {
  // GP n'a pas de "lecture de piste" : on force le mode GBAV.
  if(state.meta.equip === "GP") state.meta.gbav = true;

    setBar();

    const pg = pages();
    if (state.idx < 0) state.idx = 0;
    if (state.idx > pg.length - 1) state.idx = pg.length - 1;

    const cur = pg[state.idx];

    document.body.classList.toggle("mode-step", cur !== "SUMMARY");

    btnPrev.disabled = (state.idx === 0);

    updateNavButtons(pg);

    if (cur === "INTRO") renderIntro();
    else if (cur === "SUMMARY") renderSummary();
    else renderStep(cur);

    // Apply language after each render
    try{ applyI18n(document); }catch(e){}
    updateNavButtons(pg);
    
    // Attacher le picker aux inputs num√©riques
    attachPickerToInputs();
  }
  
  // Fonction pour attacher le picker √† tous les inputs num√©riques
  function attachPickerToInputs() {
    // S√©lectionner tous les inputs avec inputmode="decimal" dans le panel principal
    const numericInputs = main.querySelectorAll('input[inputmode="decimal"]');
    
    numericInputs.forEach(input => {
      // √âviter d'attacher plusieurs fois
      if (input.dataset.pickerAttached) return;
      input.dataset.pickerAttached = 'true';
      // Saisie clavier + picker (cohabitation)
      input.removeAttribute('readonly');
      input.style.cursor = 'text';
      input.style.touchAction = 'manipulation'; // avoid double-tap zoom & improve dblclick on touch

      
      // Ouvrir le picker (appel√© par le bouton)
      const openPicker = (e) => {
        e.preventDefault();
        
        

// ---- Profil/context (defaults intelligents) ----
const current = (input.value || '').trim();

// Unit√© (affich√©e √† droite du champ)
const unitSpan = input.parentElement?.querySelector('.unit');
const unit = unitSpan ? unitSpan.textContent.trim() : '';

// Identifier du champ (beaucoup plus fiable que le texte)
const fid = (input.id || '').toLowerCase();

// Texte descriptif (fallback si on n'a pas d'id parlant)
const desc = (
  input.getAttribute('aria-label') ||
  input.closest('.step')?.querySelector('.stepTitle')?.textContent ||
  input.closest('.step')?.querySelector('.stepHeader')?.textContent ||
  input.parentElement?.previousElementSibling?.textContent ||
  input.placeholder ||
  ''
).trim();

const descL = desc.toLowerCase();

// Helpers
const has = (s) => descL.includes(s);
const hasAny = (arr) => arr.some(s => descL.includes(s));

// D√©tection robuste (FR/EN + ID)
const isSDM = fid.includes('sdm') || unit.includes('%') || has('sdm');
const isRF  = fid.includes('rf') || unit.toLowerCase().includes('db') || hasAny(['rf', 'niveau rf', 'rf level']);
const is90CS  = fid.startsWith('s90') || fid.includes('90') && hasAny(['course', 'secteur', 'sector', 'cs']);
const is150CS = fid.startsWith('s150') || fid.includes('150') && hasAny(['course', 'secteur', 'sector', 'cs']);

// Width DDM (flight cal) ‚Äî defaults fixes
const isW90  = fid.includes('w90')  || hasAny(['90hz width', '90 hz width', 'width 90', 'largeur 90', '90hz largeur']);
const isW150 = fid.includes('w150') || hasAny(['150hz width', '150 hz width', 'width 150', 'largeur 150', '150hz largeur']);

// D√©cimales
const decimals = isSDM ? 2 : 1;

// Defaults + signe verrouill√© selon ton besoin
let defaultValue = current || (isSDM ? '40.00' : '0.0');
let allowNegative = true;
let lockedSign = null;

// IMPORTANT: signe n√©gatif utilise le caract√®re "‚àí" (U+2212) pour matcher le picker
if (is90CS) {
  defaultValue = current || '-70.0';
  lockedSign = '‚àí';
  allowNegative = true;
} else if (is150CS) {
  defaultValue = current || '70.0';
  lockedSign = '+';
  allowNegative = true;
} else if (isW90) {
  defaultValue = current || '-70.0';
  lockedSign = '‚àí';
  allowNegative = true;
} else if (isW150) {
  defaultValue = current || '70.0';
  lockedSign = '+';
  allowNegative = true;
} else if (isRF) {
  defaultValue = current || '-40.0';
  lockedSign = '‚àí';
  allowNegative = true;
} else if (isSDM) {
  defaultValue = current || '40.00';
  lockedSign = '+';
  allowNegative = false;
}
NumberPicker.openForInput(input, {

defaultValue: defaultValue,
unit: unit,
title: 'Entrer la valeur',
label: desc,
allowNegative: allowNegative,
decimals: decimals,
lockedSign: lockedSign
        });
      };

      // Picker + clavier partout (sans bouton d√©di√©)
      // - Double-clic (desktop) : ouvre le picker
      // - Long-press ~350ms (touch) : ouvre le picker sans bloquer la saisie
      // - Raccourcis clavier : Alt+‚Üì ou Ctrl+Espace
      input.addEventListener('dblclick', (e) => { e.preventDefault(); openPicker(e); });

      input.addEventListener('keydown', (e) => {
        const isAltDown = e.altKey && e.key === 'ArrowDown';
        const isCtrlSpace = e.ctrlKey && (e.key === ' ' || e.code === 'Space');
        if (isAltDown || isCtrlSpace) {
          e.preventDefault();
          openPicker(e);
        }
      });

      // Touch: double-tap handled by native dblclick on supported browsers.



    });
  }


  btnPrev.addEventListener("click", () => {
    state.idx = Math.max(0, state.idx - 1);
    save();
    render();
  });

  btnHome.addEventListener("click", () => {
    // Si un long press vient de se terminer, ne pas naviguer
    if (homeLongFired) { 
      homeLongFired = false; 
      return; 
    }
    state.idx = 0;
    save();
    render();
    // Remonte au d√©but (utile sur mobile)
    try { window.scrollTo({ top: 0, behavior: "smooth" }); } catch(e){ window.scrollTo(0,0); }
  });

  btnNext.addEventListener("click", () => {
    const pg = pages();
    state.idx = Math.min(pg.length - 1, state.idx + 1);
    save();
    render();
  });

  // Swipe navigation (gauche/droite) ‚Äî sans forcer l‚Äôouverture du clavier
  (() => {
    let x0 = null, y0 = null, t0 = 0;

    const isInteractive = (el) => {
      if (!el) return false;
      const tag = (el.tagName || "").toLowerCase();
      return tag === "input" || tag === "textarea" || tag === "select" || el.isContentEditable;
    };

    document.addEventListener("touchstart", (e) => {
      if (!e.touches || e.touches.length !== 1) return;
      if (isInteractive(e.target)) return;
      const t = e.touches[0];
      x0 = t.clientX; y0 = t.clientY; t0 = Date.now();
    }, { passive: true });

    document.addEventListener("touchend", (e) => {
      if (x0 === null || y0 === null) return;
      const dt = Date.now() - t0;
      const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;

      const dx = t ? (t.clientX - x0) : 0;
      const dy = t ? (t.clientY - y0) : 0;

      x0 = y0 = null;

      if (!t) return;
      if (dt > 700) return;
      if (Math.abs(dx) < 70) return;
      if (Math.abs(dx) < Math.abs(dy) * 1.2) return;

      if (dx < 0) {
        const pg = pages();
        if (state.idx >= pg.length - 1) return;
        state.idx = Math.min(pg.length - 1, state.idx + 1);
        save(); render();
      } else {
        if (state.idx === 0) return;
        state.idx = Math.max(0, state.idx - 1);
        save(); render();
      }
    }, { passive: true });
  })();

  // Logo fallback: si l'image ne charge pas, on affiche "GBAV"
  (function(){
    const img = document.querySelector("img.logo");
    const fb = document.querySelector(".logoFallback");
    if (!img || !fb) return;
    // par d√©faut on garde le fallback visible, et on le masque si l'image charge
    img.addEventListener("load", ()=>{ fb.style.display="none"; });
    img.addEventListener("error", ()=>{ img.style.display="none"; fb.style.display="flex"; });
    // Si d√©j√† en cache
    if (img.complete && img.naturalWidth > 0) fb.style.display="none";
  })();


  // Reset modal bindings (once)
  (function(){
    const ov = document.getElementById("resetOverlay");
    if(!ov) return;
    ov.addEventListener("click", (e)=>{ if(e.target === ov) closeResetModal(); });
    window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeResetModal(); });

    const bCancel = document.getElementById("resetCancel");
    const bOk = document.getElementById("resetConfirm");
    if(bCancel) bCancel.addEventListener("click", closeResetModal);
    if(bOk) bOk.addEventListener("click", doResetAll);
  })();

  // Apply language once at startup
  try{ applyI18n(document); }catch(e){}
  load();
  render();
})();
</script>

<!-- Fin du fichier ‚Äî Version comment√©e -->

<script>
/* =====================================================
   THEME TOGGLE (isolated)
   - Day  : theme-day
   - Night: theme-night
   ===================================================== */
(function(){
  const KEY = "gbav_theme";
  const btn = document.getElementById("themeToggle");
  if(!btn) return;

  function setTheme(theme){
    document.body.classList.remove("theme-day","theme-night");
    document.body.classList.add(theme === "night" ? "theme-night" : "theme-day");
    const icon = btn.querySelector(".ttIcon");
    if(icon) icon.textContent = (theme === "night") ? "‚òÄÔ∏è" : "üåô";
    try{ localStorage.setItem(KEY, theme); }catch(e){}
  }

  let saved = "day";
  try{
    const v = localStorage.getItem(KEY);
    if(v === "night" || v === "day") saved = v;
  }catch(e){}
  setTheme(saved);

  btn.addEventListener("click", ()=>{
    const isNight = document.body.classList.contains("theme-night");
    setTheme(isNight ? "day" : "night");
  });
})();
</script>

<!-- =====================================================
     EASTER EGG: Arcade (hidden)
     Open: 5 taps on GBAV (2s)
     Close: ESC / click outside
     ===================================================== -->
<div id="arcadeOverlay" class="arcadeOverlay" aria-hidden="true">
  <div class="arcadeFrame" role="dialog" aria-label="GBAV Arcade">
    <div class="arcadeTop">
      <div class="arcadeTitle">GBAV // DASH</div>
</div>
    <canvas id="arcadeCanvas" width="360" height="520"></canvas>
    <div class="arcadeHelp">Tap: jump ‚Ä¢ Double tap: big jump ‚Ä¢ Pause: P</div>
  </div>
</div>

<script>
/* =====================================================
   EASTER EGG: "GBAV Dash" (Geometry Dash vibe)
   Open: 5 taps on .brandQuad within 2s
   Gameplay:
   - Runner auto-scrolls
   - Tap/Space to jump over spikes
   ===================================================== */
(function(){
  const brand = document.querySelector(".brandQuad");
  const overlay = document.getElementById("arcadeOverlay");
  const c = document.getElementById("arcadeCanvas");
  if(!brand || !overlay || !c) return;
  const ctx = c.getContext("2d");

  // --- Tap detector (5 taps / 2s) ---
  let taps = [];
  brand.addEventListener("click", ()=>{
    const now = Date.now();
    taps = taps.filter(t => now - t < 2000);
    taps.push(now);
    if(taps.length >= 5){
      taps = [];
      openArcade();
    }
  });

  function openArcade(){
    overlay.classList.add("isOpen");
    overlay.setAttribute("aria-hidden","false");
    start();
  }
  function closeArcade(){
    overlay.classList.remove("isOpen");
    overlay.setAttribute("aria-hidden","true");
    stop();
  }
  overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeArcade(); });
  window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeArcade(); });

  // --- Game constants ---
  const W = () => c.width;
  const H = () => c.height;

  const world = {
    g: 2400,            // gravity px/s^2
    jumpV: -820,        // small jump
    bigJumpV: -1060,    // big jump (double tap)
    speed: 270,         // scroll speed px/s
    groundY: 420,       // ground line
    spikeW: 26,
    spikeH: 30,

    shipThrust: -1850,  // px/s^2 (applied while holding)
    ufoImpulse: -520,   // px/s per tap
    cubeSpin: 12.0,     // rad/s while airborne (cube)
  };

  // --- Game state ---
  let raf = 0;
  let running = false;
  let paused = false;
  let lastTs = 0;

  let score = 0;
  let best = 0;

  const player = {
    x: 82,
    y: world.groundY,
    w: 22,
    h: 22,
    vy: 0,
    onGround: true,
    mode: "cube",      // cube | ship | ufo
    thrust: false,     // ship hold
    invuln: 0          // short grace after portal
  };

  let spikes = [];
  let platforms = [];   // {x,y,w,h}
  let portals = [];     // {x,kind} kind: ship|ufo|cube

  let spawnSpikeT = 0;
  let spawnPlatT = 0;
  let spawnPortalT = 0;

  function reset(){
    player.y = world.groundY;
    player.vy = 0;
    player.onGround = true;
    player.mode = "cube";
    player.thrust = false;
    player.invuln = 0;
    player.angle = 0;

    spikes = [];
    platforms = [];
    portals = [];
    spawnSpikeT = 0.35;
    spawnPlatT = 0.9;
    spawnPortalT = 4.2;
    score = 0;
    lastTs = 0;
  }

  function isOpen(){ return overlay.classList.contains("isOpen"); }

  // --- Input (tap = jump, double tap = big jump) ---
  let lastTapAt = 0;
  const DOUBLE_TAP_MS = 320;

  function doTap(){
    if(!isOpen() || paused) return;

    const now = performance.now();
    const isDouble = (now - lastTapAt) <= DOUBLE_TAP_MS;
    lastTapAt = now;

    if(player.mode === "cube"){
      // Geometry‚Äëdash style: double‚Äëtap gives a bigger jump.
      // If the 2nd tap arrives just after takeoff, we "upgrade" the jump in air.
      if(player.onGround){
        player.vy = isDouble ? world.bigJumpV : world.jumpV;
        player.onGround = false;
        lastJumpAt = now;
      } else {
        // upgrade window right after a normal jump
        if(isDouble && lastJumpAt > 0 && (now - lastJumpAt) <= (DOUBLE_TAP_MS + 80)){
          player.vy = Math.min(player.vy, world.bigJumpV);
        }
      }
      return;
    }

    if(player.mode === "ufo"){
      // Each tap gives an impulse (with a tiny cooldown)
      if(player.invuln > 0) return;
      player.vy = Math.min(player.vy + world.ufoImpulse,  -220);
      return;
    }

    // ship: tap toggles a short "bump" upward (optional, keeps feel snappy)
    if(player.mode === "ship"){
      player.vy = Math.min(player.vy + world.ufoImpulse*0.6, -180);
    }
  }

  // Ship hold-thrust via pointerdown/up on canvas
  c.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    if(!isOpen() || paused) return;
    if(player.mode === "ship") player.thrust = true;
    doTap();
  }, { passive:false });

  c.addEventListener("pointerup", (e)=>{
    e.preventDefault();
    player.thrust = false;
  }, { passive:false });

  c.addEventListener("pointercancel", ()=>{ player.thrust = false; });

  // Space / ArrowUp = tap, P = pause
  window.addEventListener("keydown", (e)=>{
    if(!isOpen()) return;
    const k = (e.key || "").toLowerCase();
    if(k === "p"){ paused = !paused; return; }
    if(k === " " || k === "spacebar" || k === "arrowup" || k === "w"){
      e.preventDefault();
      doTap();
    }
  });

  // --- Helpers ---
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  function randSpikeColor(){
    // bright, readable colors
    const h = Math.floor(Math.random()*360);
    return `hsl(${h} 90% 65% / 0.95)`;
  }

  function rectsOverlap(ax,ay,aw,ah, bx,by,bw,bh){
    return ax < bx+bw && ax+aw > bx && ay < by+bh && ay+ah > by;
  }

  function spawnSpike(){
    const n = 1 + ((Math.random() < 0.35) ? 1 : 0) + ((Math.random() < 0.18) ? 1 : 0);
    let x = W() + 10;
    for(let i=0;i<n;i++){
      spikes.push({ x, w: world.spikeW, h: world.spikeH, color: randSpikeColor() });
      x += world.spikeW + 10;
    }
  }

  function spawnPlatform(){
    const w = 80 + Math.floor(Math.random()*120);
    const h = 18;
    const y = world.groundY - (70 + Math.floor(Math.random()*150)); // floating blocks
    platforms.push({ x: W() + 20, y, w, h });
  }

  function spawnPortal(){
    // Deterministic cycle so you *see* it and can test it reliably
    if(typeof spawnPortal._i === "undefined") spawnPortal._i = 0;
    const seq = ["ship","ufo","cube"];
    const kind = seq[spawnPortal._i % seq.length];
    spawnPortal._i++;
    portals.push({ x: W() + 20, kind });
  }

  function setMode(kind){
    if(player.mode === kind) return;
    player.mode = kind;
    player.thrust = false;
    player.invuln = 0.18; // small grace so portal doesn't insta-kill
  }

  function die(){
    best = Math.max(best, score|0);
    // quick "flash" then reset
    reset();
  }

  function physics(dt){
    // scroll world
    const dx = world.speed * dt;
    for(const s of spikes) s.x -= dx;
    for(const p of platforms) p.x -= dx;
    for(const po of portals) po.x -= dx;

    spikes = spikes.filter(s => s.x + s.w > -50);
    platforms = platforms.filter(p => p.x + p.w > -80);
    portals = portals.filter(po => po.x > -80);

    // gravity + ship thrust
    let ay = world.g;
    if(player.mode === "ship" && player.thrust) ay += world.shipThrust;

    player.vy += ay * dt;
    player.y += player.vy * dt;

    // ceiling clamp
    if(player.y < 40){
      player.y = 40;
      if(player.vy < 0) player.vy = 0;
    }

    // ground / platform collisions
    player.onGround = false;

    // platforms: only land from above
    const px = player.x, pw = player.w, ph = player.h;
    const prevY = player.y - player.vy*dt;

    for(const plat of platforms){
      const top = plat.y;
      const withinX = (px + pw) > plat.x && px < (plat.x + plat.w);
      const falling = player.vy >= 0;
      const crossedTop = (prevY + ph) <= top && (player.y + ph) >= top;
      if(withinX && falling && crossedTop){
        player.y = top - ph;
        player.vy = 0;
        player.onGround = true;
      }
    }

    // ground
    if(player.y + ph >= world.groundY){
      player.y = world.groundY - ph;
      player.vy = 0;
      player.onGround = true;
    }


    // cube spin (faster rotation while airborne)
    if(player.mode === "cube"){
      if(!player.onGround){
        player.angle = (player.angle || 0) + world.cubeSpin * dt;
      } else {
        // snap to 90¬∞ when you land (looks cleaner)
        const q = Math.PI/2;
        player.angle = Math.round((player.angle || 0)/q)*q;
      }
    }
    // portals
    for(const po of portals){
      if(rectsOverlap(px, player.y, pw, ph, po.x, world.groundY-130, 22, 130)){
        setMode(po.kind);
        po.x = -9999; // consume
      }
    }

    // collisions with spikes (only when not in invuln)
    if(player.invuln > 0){
      player.invuln = Math.max(0, player.invuln - dt);
    } else {
      for(const s of spikes){
        const sx = s.x, sy = world.groundY - s.h;
        if(rectsOverlap(px, player.y, pw, ph, sx, sy, s.w, s.h)){
          die();
          break;
        }
      }
    }

    // score
    score += dt * 10;
  }

  function draw(pausedFrame){
    // clear
    ctx.clearRect(0,0,W(),H());

    // background
    ctx.fillStyle = "rgba(0,0,0,.25)";
    ctx.fillRect(0,0,W(),H());

    // ground
    ctx.fillStyle = "rgba(255,255,255,.14)";
    ctx.fillRect(0, world.groundY, W(), 3);

    // platforms
    ctx.fillStyle = "rgba(255,255,255,.22)";
    for(const p of platforms){
      ctx.fillRect(p.x, p.y, p.w, p.h);
      // top lip
      ctx.fillStyle = "rgba(255,255,255,.35)";
      ctx.fillRect(p.x, p.y, p.w, 2);
      ctx.fillStyle = "rgba(255,255,255,.22)";
    }

    // portals (simple pillars with label color hint)
    for(const po of portals){
      const x = po.x;
      const y = world.groundY-130;
      ctx.fillStyle = po.kind==="ship" ? "rgba(255,80,80,.65)" : (po.kind==="ufo" ? "rgba(120,220,255,.65)" : "rgba(180,255,140,.55)");
      ctx.fillRect(x, y, 22, 130);
      ctx.fillStyle = "rgba(0,0,0,.35)";
      ctx.fillRect(x+3, y+6, 16, 22);
      ctx.fillStyle = "rgba(255,255,255,.85)";
      ctx.font = "700 10px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.textAlign = "center";
      ctx.fillText(po.kind==="cube"?"C":(po.kind==="ship"?"S":"U"), x+11, y+21);
    }

    // spikes
    for(const s of spikes){
      ctx.fillStyle = s.color || "rgba(255,255,255,.85)";
      const x = s.x;
      const y = world.groundY;
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x + s.w/2, y - s.h);
      ctx.lineTo(x + s.w, y);
      ctx.closePath();
      ctx.fill();
    }

    // player
    const x = player.x, y = player.y;
    ctx.save();
    ctx.translate(x + player.w/2, y + player.h/2);

    // little rotation only for cube
    if(player.mode === "cube"){
      const tilt = clamp(player.vy / 1400, -0.35, 0.35);
      ctx.rotate((player.angle || 0) + tilt);
      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.fillRect(-player.w/2, -player.h/2, player.w, player.h);
    } else if(player.mode === "ship"){
      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.beginPath();
      ctx.moveTo(-12, 8);
      ctx.lineTo(12, 0);
      ctx.lineTo(-12, -8);
      ctx.closePath();
      ctx.fill();
      // exhaust
      if(player.thrust){
        ctx.fillStyle = "rgba(255,255,255,.55)";
        ctx.fillRect(-16, -3, 6, 6);
      }
    } else { // ufo
      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.beginPath();
      ctx.ellipse(0, 2, 12, 6, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "rgba(0,0,0,.25)";
      ctx.beginPath();
      ctx.ellipse(0, 0, 6, 3, 0, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();

    // HUD
    ctx.fillStyle = "rgba(255,255,255,.9)";
    ctx.font = "700 14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "left";
    ctx.fillText("Score " + (score|0), 12, 24);
    ctx.fillText("Best " + (best|0), 12, 44);

    ctx.textAlign = "right";
    ctx.fillText(player.mode.toUpperCase(), W()-12, 24);

    if(pausedFrame){
      ctx.fillStyle = "rgba(0,0,0,.55)";
      ctx.fillRect(0,0,W(),H());
      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.font = "800 20px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.textAlign = "center";
      ctx.fillText("PAUSE", W()/2, H()/2 - 8);
      ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Press P to resume", W()/2, H()/2 + 14);
    }
  }

  function loop(ts){
    if(!running) return;
    raf = requestAnimationFrame(loop);

    if(paused){
      draw(true);
      return;
    }

    if(!lastTs) lastTs = ts;
    const dt = Math.min(0.033, (ts - lastTs) / 1000);
    lastTs = ts;

    // spawn cadence
    spawnSpikeT -= dt;
    spawnPlatT  -= dt;
    spawnPortalT-= dt;

    if(spawnSpikeT <= 0){
      spawnSpike();
      spawnSpikeT = 0.7 + Math.random()*0.55;
    }

    if(spawnPlatT <= 0){
      if(Math.random() < 0.75) spawnPlatform();
      spawnPlatT = 1.1 + Math.random()*1.2;
    }

    if(spawnPortalT <= 0){
      spawnPortal();
      spawnPortalT = 3.2 + Math.random()*2.4;
    }

    physics(dt);
    draw(false);
  }

  function start(){
    if(running) return;
    running = true;
    paused = false;
    reset();
    raf = requestAnimationFrame(loop);
  }

  function stop(){
    running = false;
    paused = false;
    player.thrust = false;
    cancelAnimationFrame(raf);
  }

})();;
</script>

</body>
</html>
